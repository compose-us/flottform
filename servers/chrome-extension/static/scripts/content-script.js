var FlottForm=function(P){"use strict";var en=Object.defineProperty;var nn=(P,L,B)=>L in P?en(P,L,{enumerable:!0,configurable:!0,writable:!0,value:B}):P[L]=B;var h=(P,L,B)=>nn(P,typeof L!="symbol"?L+"":L,B);var I=(P,L,B)=>new Promise((T,z)=>{var ot=D=>{try{O(B.next(D))}catch(k){z(k)}},H=D=>{try{O(B.throw(D))}catch(k){z(k)}},O=D=>D.done?T(D.value):Promise.resolve(D.value).then(ot,H);O((B=B.apply(P,L)).next())});var L=function(){return typeof Promise=="function"&&Promise.prototype&&Promise.prototype.then},B={},T={};let z;const ot=[0,26,44,70,100,134,172,196,242,292,346,404,466,532,581,655,733,815,901,991,1085,1156,1258,1364,1474,1588,1706,1828,1921,2051,2185,2323,2465,2611,2761,2876,3034,3196,3362,3532,3706];T.getSymbolSize=function(i){if(!i)throw new Error('"version" cannot be null or undefined');if(i<1||i>40)throw new Error('"version" should be in range from 1 to 40');return i*4+17},T.getSymbolTotalCodewords=function(i){return ot[i]},T.getBCHDigit=function(n){let i=0;for(;n!==0;)i++,n>>>=1;return i},T.setToSJISFunction=function(i){if(typeof i!="function")throw new Error('"toSJISFunc" is not a valid function.');z=i},T.isKanjiModeEnabled=function(){return typeof z!="undefined"},T.toSJIS=function(i){return z(i)};var H={};(function(n){n.L={bit:1},n.M={bit:0},n.Q={bit:3},n.H={bit:2};function i(t){if(typeof t!="string")throw new Error("Param is not a string");switch(t.toLowerCase()){case"l":case"low":return n.L;case"m":case"medium":return n.M;case"q":case"quartile":return n.Q;case"h":case"high":return n.H;default:throw new Error("Unknown EC Level: "+t)}}n.isValid=function(e){return e&&typeof e.bit!="undefined"&&e.bit>=0&&e.bit<4},n.from=function(e,o){if(n.isValid(e))return e;try{return i(e)}catch(r){return o}}})(H);function O(){this.buffer=[],this.length=0}O.prototype={get:function(n){const i=Math.floor(n/8);return(this.buffer[i]>>>7-n%8&1)===1},put:function(n,i){for(let t=0;t<i;t++)this.putBit((n>>>i-t-1&1)===1)},getLengthInBits:function(){return this.length},putBit:function(n){const i=Math.floor(this.length/8);this.buffer.length<=i&&this.buffer.push(0),n&&(this.buffer[i]|=128>>>this.length%8),this.length++}};var D=O;function k(n){if(!n||n<1)throw new Error("BitMatrix size must be defined and greater than 0");this.size=n,this.data=new Uint8Array(n*n),this.reservedBit=new Uint8Array(n*n)}k.prototype.set=function(n,i,t,e){const o=n*this.size+i;this.data[o]=t,e&&(this.reservedBit[o]=!0)},k.prototype.get=function(n,i){return this.data[n*this.size+i]},k.prototype.xor=function(n,i,t){this.data[n*this.size+i]^=t},k.prototype.isReserved=function(n,i){return this.reservedBit[n*this.size+i]};var Gt=k,bt={};(function(n){const i=T.getSymbolSize;n.getRowColCoords=function(e){if(e===1)return[];const o=Math.floor(e/7)+2,r=i(e),s=r===145?26:Math.ceil((r-13)/(2*o-2))*2,c=[r-7];for(let a=1;a<o-1;a++)c[a]=c[a-1]-s;return c.push(6),c.reverse()},n.getPositions=function(e){const o=[],r=n.getRowColCoords(e),s=r.length;for(let c=0;c<s;c++)for(let a=0;a<s;a++)c===0&&a===0||c===0&&a===s-1||c===s-1&&a===0||o.push([r[c],r[a]]);return o}})(bt);var St={};const Vt=T.getSymbolSize,Ft=7;St.getPositions=function(i){const t=Vt(i);return[[0,0],[t-Ft,0],[0,t-Ft]]};var It={};(function(n){n.Patterns={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};const i={N1:3,N2:3,N3:40,N4:10};n.isValid=function(o){return o!=null&&o!==""&&!isNaN(o)&&o>=0&&o<=7},n.from=function(o){return n.isValid(o)?parseInt(o,10):void 0},n.getPenaltyN1=function(o){const r=o.size;let s=0,c=0,a=0,l=null,u=null;for(let m=0;m<r;m++){c=a=0,l=u=null;for(let f=0;f<r;f++){let d=o.get(m,f);d===l?c++:(c>=5&&(s+=i.N1+(c-5)),l=d,c=1),d=o.get(f,m),d===u?a++:(a>=5&&(s+=i.N1+(a-5)),u=d,a=1)}c>=5&&(s+=i.N1+(c-5)),a>=5&&(s+=i.N1+(a-5))}return s},n.getPenaltyN2=function(o){const r=o.size;let s=0;for(let c=0;c<r-1;c++)for(let a=0;a<r-1;a++){const l=o.get(c,a)+o.get(c,a+1)+o.get(c+1,a)+o.get(c+1,a+1);(l===4||l===0)&&s++}return s*i.N2},n.getPenaltyN3=function(o){const r=o.size;let s=0,c=0,a=0;for(let l=0;l<r;l++){c=a=0;for(let u=0;u<r;u++)c=c<<1&2047|o.get(l,u),u>=10&&(c===1488||c===93)&&s++,a=a<<1&2047|o.get(u,l),u>=10&&(a===1488||a===93)&&s++}return s*i.N3},n.getPenaltyN4=function(o){let r=0;const s=o.data.length;for(let a=0;a<s;a++)r+=o.data[a];return Math.abs(Math.ceil(r*100/s/5)-10)*i.N4};function t(e,o,r){switch(e){case n.Patterns.PATTERN000:return(o+r)%2===0;case n.Patterns.PATTERN001:return o%2===0;case n.Patterns.PATTERN010:return r%3===0;case n.Patterns.PATTERN011:return(o+r)%3===0;case n.Patterns.PATTERN100:return(Math.floor(o/2)+Math.floor(r/3))%2===0;case n.Patterns.PATTERN101:return o*r%2+o*r%3===0;case n.Patterns.PATTERN110:return(o*r%2+o*r%3)%2===0;case n.Patterns.PATTERN111:return(o*r%3+(o+r)%2)%2===0;default:throw new Error("bad maskPattern:"+e)}}n.applyMask=function(o,r){const s=r.size;for(let c=0;c<s;c++)for(let a=0;a<s;a++)r.isReserved(a,c)||r.xor(a,c,t(o,a,c))},n.getBestMask=function(o,r){const s=Object.keys(n.Patterns).length;let c=0,a=1/0;for(let l=0;l<s;l++){r(l),n.applyMask(l,o);const u=n.getPenaltyN1(o)+n.getPenaltyN2(o)+n.getPenaltyN3(o)+n.getPenaltyN4(o);n.applyMask(l,o),u<a&&(a=u,c=l)}return c}})(It);var W={};const R=H,Z=[1,1,1,1,1,1,1,1,1,1,2,2,1,2,2,4,1,2,4,4,2,4,4,4,2,4,6,5,2,4,6,6,2,5,8,8,4,5,8,8,4,5,8,11,4,8,10,11,4,9,12,16,4,9,16,16,6,10,12,18,6,10,17,16,6,11,16,19,6,13,18,21,7,14,21,25,8,16,20,25,8,17,23,25,9,17,23,34,9,18,25,30,10,20,27,32,12,21,29,35,12,23,34,37,12,25,34,40,13,26,35,42,14,28,38,45,15,29,40,48,16,31,43,51,17,33,45,54,18,35,48,57,19,37,51,60,19,38,53,63,20,40,56,66,21,43,59,70,22,45,62,74,24,47,65,77,25,49,68,81],X=[7,10,13,17,10,16,22,28,15,26,36,44,20,36,52,64,26,48,72,88,36,64,96,112,40,72,108,130,48,88,132,156,60,110,160,192,72,130,192,224,80,150,224,264,96,176,260,308,104,198,288,352,120,216,320,384,132,240,360,432,144,280,408,480,168,308,448,532,180,338,504,588,196,364,546,650,224,416,600,700,224,442,644,750,252,476,690,816,270,504,750,900,300,560,810,960,312,588,870,1050,336,644,952,1110,360,700,1020,1200,390,728,1050,1260,420,784,1140,1350,450,812,1200,1440,480,868,1290,1530,510,924,1350,1620,540,980,1440,1710,570,1036,1530,1800,570,1064,1590,1890,600,1120,1680,1980,630,1204,1770,2100,660,1260,1860,2220,720,1316,1950,2310,750,1372,2040,2430];W.getBlocksCount=function(i,t){switch(t){case R.L:return Z[(i-1)*4+0];case R.M:return Z[(i-1)*4+1];case R.Q:return Z[(i-1)*4+2];case R.H:return Z[(i-1)*4+3];default:return}},W.getTotalCodewordsCount=function(i,t){switch(t){case R.L:return X[(i-1)*4+0];case R.M:return X[(i-1)*4+1];case R.Q:return X[(i-1)*4+2];case R.H:return X[(i-1)*4+3];default:return}};var Et={},tt={};const V=new Uint8Array(512),et=new Uint8Array(256);(function(){let i=1;for(let t=0;t<255;t++)V[t]=i,et[i]=t,i<<=1,i&256&&(i^=285);for(let t=255;t<512;t++)V[t]=V[t-255]})(),tt.log=function(i){if(i<1)throw new Error("log("+i+")");return et[i]},tt.exp=function(i){return V[i]},tt.mul=function(i,t){return i===0||t===0?0:V[et[i]+et[t]]},function(n){const i=tt;n.mul=function(e,o){const r=new Uint8Array(e.length+o.length-1);for(let s=0;s<e.length;s++)for(let c=0;c<o.length;c++)r[s+c]^=i.mul(e[s],o[c]);return r},n.mod=function(e,o){let r=new Uint8Array(e);for(;r.length-o.length>=0;){const s=r[0];for(let a=0;a<o.length;a++)r[a]^=i.mul(o[a],s);let c=0;for(;c<r.length&&r[c]===0;)c++;r=r.slice(c)}return r},n.generateECPolynomial=function(e){let o=new Uint8Array([1]);for(let r=0;r<e;r++)o=n.mul(o,new Uint8Array([1,i.exp(r)]));return o}}(Et);const At=Et;function rt(n){this.genPoly=void 0,this.degree=n,this.degree&&this.initialize(this.degree)}rt.prototype.initialize=function(i){this.degree=i,this.genPoly=At.generateECPolynomial(this.degree)},rt.prototype.encode=function(i){if(!this.genPoly)throw new Error("Encoder not initialized");const t=new Uint8Array(i.length+this.degree);t.set(i);const e=At.mod(t,this.genPoly),o=this.degree-e.length;if(o>0){const r=new Uint8Array(this.degree);return r.set(e,o),r}return e};var jt=rt,Pt={},$={},st={};st.isValid=function(i){return!isNaN(i)&&i>=1&&i<=40};var N={};const Tt="[0-9]+",xt="[A-Z $%*+\\-./:]+";let j="(?:[u3000-u303F]|[u3040-u309F]|[u30A0-u30FF]|[uFF00-uFFEF]|[u4E00-u9FAF]|[u2605-u2606]|[u2190-u2195]|u203B|[u2010u2015u2018u2019u2025u2026u201Cu201Du2225u2260]|[u0391-u0451]|[u00A7u00A8u00B1u00B4u00D7u00F7])+";j=j.replace(/u/g,"\\u");const Yt="(?:(?![A-Z0-9 $%*+\\-./:]|"+j+`)(?:.|[\r
]))+`;N.KANJI=new RegExp(j,"g"),N.BYTE_KANJI=new RegExp("[^A-Z0-9 $%*+\\-./:]+","g"),N.BYTE=new RegExp(Yt,"g"),N.NUMERIC=new RegExp(Tt,"g"),N.ALPHANUMERIC=new RegExp(xt,"g");const Qt=new RegExp("^"+j+"$"),Wt=new RegExp("^"+Tt+"$"),Zt=new RegExp("^[A-Z0-9 $%*+\\-./:]+$");N.testKanji=function(i){return Qt.test(i)},N.testNumeric=function(i){return Wt.test(i)},N.testAlphanumeric=function(i){return Zt.test(i)},function(n){const i=st,t=N;n.NUMERIC={id:"Numeric",bit:1,ccBits:[10,12,14]},n.ALPHANUMERIC={id:"Alphanumeric",bit:2,ccBits:[9,11,13]},n.BYTE={id:"Byte",bit:4,ccBits:[8,16,16]},n.KANJI={id:"Kanji",bit:8,ccBits:[8,10,12]},n.MIXED={bit:-1},n.getCharCountIndicator=function(r,s){if(!r.ccBits)throw new Error("Invalid mode: "+r);if(!i.isValid(s))throw new Error("Invalid version: "+s);return s>=1&&s<10?r.ccBits[0]:s<27?r.ccBits[1]:r.ccBits[2]},n.getBestModeForData=function(r){return t.testNumeric(r)?n.NUMERIC:t.testAlphanumeric(r)?n.ALPHANUMERIC:t.testKanji(r)?n.KANJI:n.BYTE},n.toString=function(r){if(r&&r.id)return r.id;throw new Error("Invalid mode")},n.isValid=function(r){return r&&r.bit&&r.ccBits};function e(o){if(typeof o!="string")throw new Error("Param is not a string");switch(o.toLowerCase()){case"numeric":return n.NUMERIC;case"alphanumeric":return n.ALPHANUMERIC;case"kanji":return n.KANJI;case"byte":return n.BYTE;default:throw new Error("Unknown mode: "+o)}}n.from=function(r,s){if(n.isValid(r))return r;try{return e(r)}catch(c){return s}}}($),function(n){const i=T,t=W,e=H,o=$,r=st,s=7973,c=i.getBCHDigit(s);function a(f,d,y){for(let w=1;w<=40;w++)if(d<=n.getCapacity(w,y,f))return w}function l(f,d){return o.getCharCountIndicator(f,d)+4}function u(f,d){let y=0;return f.forEach(function(w){const E=l(w.mode,d);y+=E+w.getBitsLength()}),y}function m(f,d){for(let y=1;y<=40;y++)if(u(f,y)<=n.getCapacity(y,d,o.MIXED))return y}n.from=function(d,y){return r.isValid(d)?parseInt(d,10):y},n.getCapacity=function(d,y,w){if(!r.isValid(d))throw new Error("Invalid QR Code version");typeof w=="undefined"&&(w=o.BYTE);const E=i.getSymbolTotalCodewords(d),C=t.getTotalCodewordsCount(d,y),b=(E-C)*8;if(w===o.MIXED)return b;const g=b-l(w,d);switch(w){case o.NUMERIC:return Math.floor(g/10*3);case o.ALPHANUMERIC:return Math.floor(g/11*2);case o.KANJI:return Math.floor(g/13);case o.BYTE:default:return Math.floor(g/8)}},n.getBestVersionForData=function(d,y){let w;const E=e.from(y,e.M);if(Array.isArray(d)){if(d.length>1)return m(d,E);if(d.length===0)return 1;w=d[0]}else w=d;return a(w.mode,w.getLength(),E)},n.getEncodedBits=function(d){if(!r.isValid(d)||d<7)throw new Error("Invalid QR Code version");let y=d<<12;for(;i.getBCHDigit(y)-c>=0;)y^=s<<i.getBCHDigit(y)-c;return d<<12|y}}(Pt);var Bt={};const at=T,Lt=1335,Xt=21522,Mt=at.getBCHDigit(Lt);Bt.getEncodedBits=function(i,t){const e=i.bit<<3|t;let o=e<<10;for(;at.getBCHDigit(o)-Mt>=0;)o^=Lt<<at.getBCHDigit(o)-Mt;return(e<<10|o)^Xt};var Nt={};const te=$;function q(n){this.mode=te.NUMERIC,this.data=n.toString()}q.getBitsLength=function(i){return 10*Math.floor(i/3)+(i%3?i%3*3+1:0)},q.prototype.getLength=function(){return this.data.length},q.prototype.getBitsLength=function(){return q.getBitsLength(this.data.length)},q.prototype.write=function(i){let t,e,o;for(t=0;t+3<=this.data.length;t+=3)e=this.data.substr(t,3),o=parseInt(e,10),i.put(o,10);const r=this.data.length-t;r>0&&(e=this.data.substr(t),o=parseInt(e,10),i.put(o,r*3+1))};var ee=q;const ne=$,ct=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"," ","$","%","*","+","-",".","/",":"];function J(n){this.mode=ne.ALPHANUMERIC,this.data=n}J.getBitsLength=function(i){return 11*Math.floor(i/2)+6*(i%2)},J.prototype.getLength=function(){return this.data.length},J.prototype.getBitsLength=function(){return J.getBitsLength(this.data.length)},J.prototype.write=function(i){let t;for(t=0;t+2<=this.data.length;t+=2){let e=ct.indexOf(this.data[t])*45;e+=ct.indexOf(this.data[t+1]),i.put(e,11)}this.data.length%2&&i.put(ct.indexOf(this.data[t]),6)};var ie=J;const oe=$;function K(n){this.mode=oe.BYTE,typeof n=="string"?this.data=new TextEncoder().encode(n):this.data=new Uint8Array(n)}K.getBitsLength=function(i){return i*8},K.prototype.getLength=function(){return this.data.length},K.prototype.getBitsLength=function(){return K.getBitsLength(this.data.length)},K.prototype.write=function(n){for(let i=0,t=this.data.length;i<t;i++)n.put(this.data[i],8)};var re=K;const se=$,ae=T;function G(n){this.mode=se.KANJI,this.data=n}G.getBitsLength=function(i){return i*13},G.prototype.getLength=function(){return this.data.length},G.prototype.getBitsLength=function(){return G.getBitsLength(this.data.length)},G.prototype.write=function(n){let i;for(i=0;i<this.data.length;i++){let t=ae.toSJIS(this.data[i]);if(t>=33088&&t<=40956)t-=33088;else if(t>=57408&&t<=60351)t-=49472;else throw new Error("Invalid SJIS character: "+this.data[i]+`
Make sure your charset is UTF-8`);t=(t>>>8&255)*192+(t&255),n.put(t,13)}};var ce=G,vt={exports:{}};(function(n){var i={single_source_shortest_paths:function(t,e,o){var r={},s={};s[e]=0;var c=i.PriorityQueue.make();c.push(e,0);for(var a,l,u,m,f,d,y,w,E;!c.empty();){a=c.pop(),l=a.value,m=a.cost,f=t[l]||{};for(u in f)f.hasOwnProperty(u)&&(d=f[u],y=m+d,w=s[u],E=typeof s[u]=="undefined",(E||w>y)&&(s[u]=y,c.push(u,y),r[u]=l))}if(typeof o!="undefined"&&typeof s[o]=="undefined"){var C=["Could not find a path from ",e," to ",o,"."].join("");throw new Error(C)}return r},extract_shortest_path_from_predecessor_list:function(t,e){for(var o=[],r=e;r;)o.push(r),t[r],r=t[r];return o.reverse(),o},find_path:function(t,e,o){var r=i.single_source_shortest_paths(t,e,o);return i.extract_shortest_path_from_predecessor_list(r,o)},PriorityQueue:{make:function(t){var e=i.PriorityQueue,o={},r;t=t||{};for(r in e)e.hasOwnProperty(r)&&(o[r]=e[r]);return o.queue=[],o.sorter=t.sorter||e.default_sorter,o},default_sorter:function(t,e){return t.cost-e.cost},push:function(t,e){var o={value:t,cost:e};this.queue.push(o),this.queue.sort(this.sorter)},pop:function(){return this.queue.shift()},empty:function(){return this.queue.length===0}}};n.exports=i})(vt);var le=vt.exports;(function(n){const i=$,t=ee,e=ie,o=re,r=ce,s=N,c=T,a=le;function l(C){return unescape(encodeURIComponent(C)).length}function u(C,b,g){const p=[];let S;for(;(S=C.exec(g))!==null;)p.push({data:S[0],index:S.index,mode:b,length:S[0].length});return p}function m(C){const b=u(s.NUMERIC,i.NUMERIC,C),g=u(s.ALPHANUMERIC,i.ALPHANUMERIC,C);let p,S;return c.isKanjiModeEnabled()?(p=u(s.BYTE,i.BYTE,C),S=u(s.KANJI,i.KANJI,C)):(p=u(s.BYTE_KANJI,i.BYTE,C),S=[]),b.concat(g,p,S).sort(function(A,M){return A.index-M.index}).map(function(A){return{data:A.data,mode:A.mode,length:A.length}})}function f(C,b){switch(b){case i.NUMERIC:return t.getBitsLength(C);case i.ALPHANUMERIC:return e.getBitsLength(C);case i.KANJI:return r.getBitsLength(C);case i.BYTE:return o.getBitsLength(C)}}function d(C){return C.reduce(function(b,g){const p=b.length-1>=0?b[b.length-1]:null;return p&&p.mode===g.mode?(b[b.length-1].data+=g.data,b):(b.push(g),b)},[])}function y(C){const b=[];for(let g=0;g<C.length;g++){const p=C[g];switch(p.mode){case i.NUMERIC:b.push([p,{data:p.data,mode:i.ALPHANUMERIC,length:p.length},{data:p.data,mode:i.BYTE,length:p.length}]);break;case i.ALPHANUMERIC:b.push([p,{data:p.data,mode:i.BYTE,length:p.length}]);break;case i.KANJI:b.push([p,{data:p.data,mode:i.BYTE,length:l(p.data)}]);break;case i.BYTE:b.push([{data:p.data,mode:i.BYTE,length:l(p.data)}])}}return b}function w(C,b){const g={},p={start:{}};let S=["start"];for(let F=0;F<C.length;F++){const A=C[F],M=[];for(let _=0;_<A.length;_++){const v=A[_],Q=""+F+_;M.push(Q),g[Q]={node:v,lastCount:0},p[Q]={};for(let yt=0;yt<S.length;yt++){const U=S[yt];g[U]&&g[U].node.mode===v.mode?(p[U][Q]=f(g[U].lastCount+v.length,v.mode)-f(g[U].lastCount,v.mode),g[U].lastCount+=v.length):(g[U]&&(g[U].lastCount=v.length),p[U][Q]=f(v.length,v.mode)+4+i.getCharCountIndicator(v.mode,b))}}S=M}for(let F=0;F<S.length;F++)p[S[F]].end=0;return{map:p,table:g}}function E(C,b){let g;const p=i.getBestModeForData(C);if(g=i.from(b,p),g!==i.BYTE&&g.bit<p.bit)throw new Error('"'+C+'" cannot be encoded with mode '+i.toString(g)+`.
 Suggested mode is: `+i.toString(p));switch(g===i.KANJI&&!c.isKanjiModeEnabled()&&(g=i.BYTE),g){case i.NUMERIC:return new t(C);case i.ALPHANUMERIC:return new e(C);case i.KANJI:return new r(C);case i.BYTE:return new o(C)}}n.fromArray=function(b){return b.reduce(function(g,p){return typeof p=="string"?g.push(E(p,null)):p.data&&g.push(E(p.data,p.mode)),g},[])},n.fromString=function(b,g){const p=m(b,c.isKanjiModeEnabled()),S=y(p),F=w(S,g),A=a.find_path(F.map,"start","end"),M=[];for(let _=1;_<A.length-1;_++)M.push(F.table[A[_]].node);return n.fromArray(d(M))},n.rawSplit=function(b){return n.fromArray(m(b,c.isKanjiModeEnabled()))}})(Nt);const nt=T,lt=H,he=D,ue=Gt,fe=bt,de=St,ht=It,ut=W,ge=jt,it=Pt,pe=Bt,me=$,ft=Nt;function Ce(n,i){const t=n.size,e=de.getPositions(i);for(let o=0;o<e.length;o++){const r=e[o][0],s=e[o][1];for(let c=-1;c<=7;c++)if(!(r+c<=-1||t<=r+c))for(let a=-1;a<=7;a++)s+a<=-1||t<=s+a||(c>=0&&c<=6&&(a===0||a===6)||a>=0&&a<=6&&(c===0||c===6)||c>=2&&c<=4&&a>=2&&a<=4?n.set(r+c,s+a,!0,!0):n.set(r+c,s+a,!1,!0))}}function we(n){const i=n.size;for(let t=8;t<i-8;t++){const e=t%2===0;n.set(t,6,e,!0),n.set(6,t,e,!0)}}function ye(n,i){const t=fe.getPositions(i);for(let e=0;e<t.length;e++){const o=t[e][0],r=t[e][1];for(let s=-2;s<=2;s++)for(let c=-2;c<=2;c++)s===-2||s===2||c===-2||c===2||s===0&&c===0?n.set(o+s,r+c,!0,!0):n.set(o+s,r+c,!1,!0)}}function be(n,i){const t=n.size,e=it.getEncodedBits(i);let o,r,s;for(let c=0;c<18;c++)o=Math.floor(c/3),r=c%3+t-8-3,s=(e>>c&1)===1,n.set(o,r,s,!0),n.set(r,o,s,!0)}function dt(n,i,t){const e=n.size,o=pe.getEncodedBits(i,t);let r,s;for(r=0;r<15;r++)s=(o>>r&1)===1,r<6?n.set(r,8,s,!0):r<8?n.set(r+1,8,s,!0):n.set(e-15+r,8,s,!0),r<8?n.set(8,e-r-1,s,!0):r<9?n.set(8,15-r-1+1,s,!0):n.set(8,15-r-1,s,!0);n.set(e-8,8,1,!0)}function Se(n,i){const t=n.size;let e=-1,o=t-1,r=7,s=0;for(let c=t-1;c>0;c-=2)for(c===6&&c--;;){for(let a=0;a<2;a++)if(!n.isReserved(o,c-a)){let l=!1;s<i.length&&(l=(i[s]>>>r&1)===1),n.set(o,c-a,l),r--,r===-1&&(s++,r=7)}if(o+=e,o<0||t<=o){o-=e,e=-e;break}}}function Fe(n,i,t){const e=new he;t.forEach(function(a){e.put(a.mode.bit,4),e.put(a.getLength(),me.getCharCountIndicator(a.mode,n)),a.write(e)});const o=nt.getSymbolTotalCodewords(n),r=ut.getTotalCodewordsCount(n,i),s=(o-r)*8;for(e.getLengthInBits()+4<=s&&e.put(0,4);e.getLengthInBits()%8!==0;)e.putBit(0);const c=(s-e.getLengthInBits())/8;for(let a=0;a<c;a++)e.put(a%2?17:236,8);return Ie(e,n,i)}function Ie(n,i,t){const e=nt.getSymbolTotalCodewords(i),o=ut.getTotalCodewordsCount(i,t),r=e-o,s=ut.getBlocksCount(i,t),c=e%s,a=s-c,l=Math.floor(e/s),u=Math.floor(r/s),m=u+1,f=l-u,d=new ge(f);let y=0;const w=new Array(s),E=new Array(s);let C=0;const b=new Uint8Array(n.buffer);for(let A=0;A<s;A++){const M=A<a?u:m;w[A]=b.slice(y,y+M),E[A]=d.encode(w[A]),y+=M,C=Math.max(C,M)}const g=new Uint8Array(e);let p=0,S,F;for(S=0;S<C;S++)for(F=0;F<s;F++)S<w[F].length&&(g[p++]=w[F][S]);for(S=0;S<f;S++)for(F=0;F<s;F++)g[p++]=E[F][S];return g}function Ee(n,i,t,e){let o;if(Array.isArray(n))o=ft.fromArray(n);else if(typeof n=="string"){let l=i;if(!l){const u=ft.rawSplit(n);l=it.getBestVersionForData(u,t)}o=ft.fromString(n,l||40)}else throw new Error("Invalid data");const r=it.getBestVersionForData(o,t);if(!r)throw new Error("The amount of data is too big to be stored in a QR Code");if(!i)i=r;else if(i<r)throw new Error(`
The chosen QR Code version cannot contain this amount of data.
Minimum version required to store current data is: `+r+`.
`);const s=Fe(i,t,o),c=nt.getSymbolSize(i),a=new ue(c);return Ce(a,i),we(a),ye(a,i),dt(a,t,0),i>=7&&be(a,i),Se(a,s),isNaN(e)&&(e=ht.getBestMask(a,dt.bind(null,a,t))),ht.applyMask(e,a),dt(a,t,e),{modules:a,version:i,errorCorrectionLevel:t,maskPattern:e,segments:o}}B.create=function(i,t){if(typeof i=="undefined"||i==="")throw new Error("No input text");let e=lt.M,o,r;return typeof t!="undefined"&&(e=lt.from(t.errorCorrectionLevel,lt.M),o=it.from(t.version),r=ht.from(t.maskPattern),t.toSJISFunc&&nt.setToSJISFunction(t.toSJISFunc)),Ee(i,o,e,r)};var Dt={},gt={};(function(n){function i(t){if(typeof t=="number"&&(t=t.toString()),typeof t!="string")throw new Error("Color should be defined as hex string");let e=t.slice().replace("#","").split("");if(e.length<3||e.length===5||e.length>8)throw new Error("Invalid hex color: "+t);(e.length===3||e.length===4)&&(e=Array.prototype.concat.apply([],e.map(function(r){return[r,r]}))),e.length===6&&e.push("F","F");const o=parseInt(e.join(""),16);return{r:o>>24&255,g:o>>16&255,b:o>>8&255,a:o&255,hex:"#"+e.slice(0,6).join("")}}n.getOptions=function(e){e||(e={}),e.color||(e.color={});const o=typeof e.margin=="undefined"||e.margin===null||e.margin<0?4:e.margin,r=e.width&&e.width>=21?e.width:void 0,s=e.scale||4;return{width:r,scale:r?4:s,margin:o,color:{dark:i(e.color.dark||"#000000ff"),light:i(e.color.light||"#ffffffff")},type:e.type,rendererOpts:e.rendererOpts||{}}},n.getScale=function(e,o){return o.width&&o.width>=e+o.margin*2?o.width/(e+o.margin*2):o.scale},n.getImageWidth=function(e,o){const r=n.getScale(e,o);return Math.floor((e+o.margin*2)*r)},n.qrToImageData=function(e,o,r){const s=o.modules.size,c=o.modules.data,a=n.getScale(s,r),l=Math.floor((s+r.margin*2)*a),u=r.margin*a,m=[r.color.light,r.color.dark];for(let f=0;f<l;f++)for(let d=0;d<l;d++){let y=(f*l+d)*4,w=r.color.light;if(f>=u&&d>=u&&f<l-u&&d<l-u){const E=Math.floor((f-u)/a),C=Math.floor((d-u)/a);w=m[c[E*s+C]?1:0]}e[y++]=w.r,e[y++]=w.g,e[y++]=w.b,e[y]=w.a}}})(gt),function(n){const i=gt;function t(o,r,s){o.clearRect(0,0,r.width,r.height),r.style||(r.style={}),r.height=s,r.width=s,r.style.height=s+"px",r.style.width=s+"px"}function e(){try{return document.createElement("canvas")}catch(o){throw new Error("You need to specify a canvas element")}}n.render=function(r,s,c){let a=c,l=s;typeof a=="undefined"&&(!s||!s.getContext)&&(a=s,s=void 0),s||(l=e()),a=i.getOptions(a);const u=i.getImageWidth(r.modules.size,a),m=l.getContext("2d"),f=m.createImageData(u,u);return i.qrToImageData(f.data,r,a),t(m,l,u),m.putImageData(f,0,0),l},n.renderToDataURL=function(r,s,c){let a=c;typeof a=="undefined"&&(!s||!s.getContext)&&(a=s,s=void 0),a||(a={});const l=n.render(r,s,a),u=a.type||"image/png",m=a.rendererOpts||{};return l.toDataURL(u,m.quality)}}(Dt);var kt={};const Ae=gt;function Ut(n,i){const t=n.a/255,e=i+'="'+n.hex+'"';return t<1?e+" "+i+'-opacity="'+t.toFixed(2).slice(1)+'"':e}function pt(n,i,t){let e=n+i;return typeof t!="undefined"&&(e+=" "+t),e}function Pe(n,i,t){let e="",o=0,r=!1,s=0;for(let c=0;c<n.length;c++){const a=Math.floor(c%i),l=Math.floor(c/i);!a&&!r&&(r=!0),n[c]?(s++,c>0&&a>0&&n[c-1]||(e+=r?pt("M",a+t,.5+l+t):pt("m",o,0),o=0,r=!1),a+1<i&&n[c+1]||(e+=pt("h",s),s=0)):o++}return e}kt.render=function(i,t,e){const o=Ae.getOptions(t),r=i.modules.size,s=i.modules.data,c=r+o.margin*2,a=o.color.light.a?"<path "+Ut(o.color.light,"fill")+' d="M0 0h'+c+"v"+c+'H0z"/>':"",l="<path "+Ut(o.color.dark,"stroke")+' d="'+Pe(s,r,o.margin)+'"/>',u='viewBox="0 0 '+c+" "+c+'"',f='<svg xmlns="http://www.w3.org/2000/svg" '+(o.width?'width="'+o.width+'" height="'+o.width+'" ':"")+u+' shape-rendering="crispEdges">'+a+l+`</svg>
`;return typeof e=="function"&&e(null,f),f};const Te=L,mt=B,Rt=Dt,Be=kt;function Ct(n,i,t,e,o){const r=[].slice.call(arguments,1),s=r.length,c=typeof r[s-1]=="function";if(!c&&!Te())throw new Error("Callback required as last argument");if(c){if(s<2)throw new Error("Too few arguments provided");s===2?(o=t,t=i,i=e=void 0):s===3&&(i.getContext&&typeof o=="undefined"?(o=e,e=void 0):(o=e,e=t,t=i,i=void 0))}else{if(s<1)throw new Error("Too few arguments provided");return s===1?(t=i,i=e=void 0):s===2&&!i.getContext&&(e=t,t=i,i=void 0),new Promise(function(a,l){try{const u=mt.create(t,e);a(n(u,i,e))}catch(u){l(u)}})}try{const a=mt.create(t,e);o(null,n(a,i,e))}catch(a){o(a)}}mt.create,Ct.bind(null,Rt.render);var Le=Ct.bind(null,Rt.renderToDataURL);Ct.bind(null,function(n,i,t){return Be.render(n,t)});const x=1e3,$t={iceServers:[{urls:["stun:stun1.l.google.com:19302"]}]};function Me(){return crypto.randomUUID()}function wt(n){return I(this,null,function*(){return yield(yield fetch(n)).json()})}function _t(n,i){for(const t of n)if(JSON.stringify(t)===JSON.stringify(i))return!0;return!1}class Y{constructor(){h(this,"eventListeners",{})}on(i,t){var o;const e=(o=this.eventListeners[i])!=null?o:new Set;e.add(t),this.eventListeners[i]=e}off(i,t){const e=this.eventListeners[i];e&&(e.delete(t),e.size===0&&delete this.eventListeners[i])}emit(i,...t){var o;const e=(o=this.eventListeners[i])!=null?o:new Set;for(const r of e)r(...t)}}class zt extends Y{}class Ht extends Y{constructor({flottformApi:t,createClientUrl:e,pollTimeForIceInMs:o,logger:r}){super();h(this,"flottformApi");h(this,"createClientUrl");h(this,"rtcConfiguration");h(this,"pollTimeForIceInMs");h(this,"logger");h(this,"state","new");h(this,"channelNumber",0);h(this,"openPeerConnection",null);h(this,"dataChannel",null);h(this,"pollForIceTimer",null);h(this,"changeState",(t,e)=>{this.state=t,this.emit(t,e),this.logger.info(`State changed to: ${t}`,e==null?"":e)});h(this,"start",()=>I(this,null,function*(){this.openPeerConnection&&this.close();const t=(this.flottformApi instanceof URL?this.flottformApi:new URL(this.flottformApi)).toString().replace(/\/$/,"");try{this.rtcConfiguration.iceServers=yield this.fetchIceServers(t)}catch(u){this.logger.error(u)}this.openPeerConnection=new RTCPeerConnection(this.rtcConfiguration),this.dataChannel=this.createDataChannel();const e=yield this.openPeerConnection.createOffer();yield this.openPeerConnection.setLocalDescription(e);const{endpointId:o,hostKey:r}=yield this.createEndpoint(t,e);this.logger.log("Created endpoint",{endpointId:o,hostKey:r});const s=`${t}/${o}`,c=`${t}/${o}/host`,a=new Set;yield this.putHostInfo(c,r,a,e),this.setUpConnectionStateGathering(s),this.setupHostIceGathering(c,r,a,e),this.setupDataChannelForTransfer();const l=yield this.createClientUrl({endpointId:o});this.changeState("waiting-for-client",{qrCode:yield Le(l),link:l,channel:this}),this.setupDataChannelListener()}));h(this,"close",()=>{this.openPeerConnection&&(this.openPeerConnection.close(),this.openPeerConnection=null),this.changeState("disconnected")});h(this,"setupDataChannelListener",()=>{if(this.dataChannel==null){this.changeState("error","dataChannel is null. Unable to setup the listeners for the data channel");return}this.dataChannel.onmessage=t=>{this.emit("receiving-data",t)}});h(this,"setupHostIceGathering",(t,e,o,r)=>{if(this.openPeerConnection===null){this.changeState("error","openPeerConnection is null. Unable to gather Host ICE candidates");return}this.openPeerConnection.onicecandidate=s=>I(this,null,function*(){this.logger.info(`onicecandidate - ${this.openPeerConnection.connectionState} - ${s.candidate}`),s.candidate&&(_t(o,s.candidate)||(this.logger.log("host found new ice candidate! Adding it to our list"),o.add(s.candidate),yield this.putHostInfo(t,e,o,r)))}),this.openPeerConnection.onicegatheringstatechange=s=>I(this,null,function*(){this.logger.info(`onicegatheringstatechange - ${this.openPeerConnection.iceGatheringState} - ${s}`)}),this.openPeerConnection.onicecandidateerror=s=>I(this,null,function*(){this.logger.error("peerConnection.onicecandidateerror",s)})});h(this,"setUpConnectionStateGathering",t=>{if(this.openPeerConnection===null){this.changeState("error","openPeerConnection is null. Unable to poll for the client's details");return}this.startPollingForConnection(t),this.openPeerConnection.onconnectionstatechange=()=>{this.logger.info(`onconnectionstatechange - ${this.openPeerConnection.connectionState}`),this.openPeerConnection.connectionState==="connected"&&this.stopPollingForConnection(),this.openPeerConnection.connectionState==="disconnected"&&this.startPollingForConnection(t),this.openPeerConnection.connectionState==="failed"&&(this.stopPollingForConnection(),this.changeState("error",{message:"connection-failed"}))},this.openPeerConnection.oniceconnectionstatechange=e=>I(this,null,function*(){this.logger.info(`oniceconnectionstatechange - ${this.openPeerConnection.iceConnectionState} - ${e}`),this.openPeerConnection.iceConnectionState==="failed"&&(this.logger.log("Failed to find a possible connection path"),this.changeState("error",{message:"connection-impossible"}))})});h(this,"stopPollingForConnection",()=>I(this,null,function*(){this.pollForIceTimer&&clearTimeout(this.pollForIceTimer),this.pollForIceTimer=null}));h(this,"startPollingForConnection",t=>I(this,null,function*(){this.pollForIceTimer&&clearTimeout(this.pollForIceTimer),yield this.pollForConnection(t),this.pollForIceTimer=setTimeout(()=>{this.startPollingForConnection(t)},this.pollTimeForIceInMs)}));h(this,"createEndpoint",(t,e)=>I(this,null,function*(){return(yield fetch(`${t}/create`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({session:e})})).json()}));h(this,"fetchIceServers",t=>I(this,null,function*(){const e=yield fetch(`${t}/ice-server-credentials`,{method:"GET",headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Fetching Error!");const o=yield e.json();if(o.success===!1)throw new Error(o.message||"Unknown error occurred");return o.iceServers}));h(this,"pollForConnection",t=>I(this,null,function*(){var o;if(this.openPeerConnection===null){this.changeState("error","openPeerConnection is null. Unable to retrieve Client's details");return}this.logger.log("polling for client ice candidates",this.openPeerConnection.iceGatheringState);const{clientInfo:e}=yield wt(t);e&&this.state==="waiting-for-client"&&(this.logger.log("Found a client that wants to connect!"),this.changeState("waiting-for-ice"),yield this.openPeerConnection.setRemoteDescription(e.session));for(const r of(o=e==null?void 0:e.iceCandidates)!=null?o:[])yield this.openPeerConnection.addIceCandidate(r)}));h(this,"setupDataChannelForTransfer",()=>{if(this.dataChannel===null){this.changeState("error","dataChannel is null. Unable to setup a Data Channel");return}this.dataChannel.onopen=()=>{this.logger.log("data channel opened"),this.changeState("waiting-for-data")},this.dataChannel.onclose=()=>{this.logger.log("data channel closed")},this.dataChannel.onerror=t=>{this.logger.log("channel.onerror",t),this.changeState("error",{message:"file-transfer"})}});h(this,"createDataChannel",()=>{if(this.openPeerConnection===null)return this.changeState("error","openPeerConnection is null. Unable to create a new Data Channel"),null;this.channelNumber++;const t=`data-channel-${this.channelNumber}`;return this.openPeerConnection.createDataChannel(t)});h(this,"putHostInfo",(t,e,o,r)=>I(this,null,function*(){try{if(this.logger.log("Updating host info with new list of ice candidates"),!(yield fetch(t,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({hostKey:e,iceCandidates:[...o],session:r})})).ok)throw Error("Could not update host info")}catch(s){this.changeState("error",s)}}));this.flottformApi=t,this.createClientUrl=e,this.rtcConfiguration=$t,this.pollTimeForIceInMs=o,this.logger=r,Promise.resolve().then(()=>{this.changeState("new",{channel:this})})}}class Ot extends zt{constructor({flottformApi:t,createClientUrl:e,inputField:o,pollTimeForIceInMs:r=x,logger:s=console}){super();h(this,"channel",null);h(this,"inputField");h(this,"logger");h(this,"filesMetaData",[]);h(this,"filesTotalSize",0);h(this,"receivedDataSize",0);h(this,"currentFile",null);h(this,"link","");h(this,"qrCode","");h(this,"start",()=>{var t;(t=this.channel)==null||t.start()});h(this,"close",()=>{var t;(t=this.channel)==null||t.close()});h(this,"getLink",()=>(this.link===""&&this.logger.error("Flottform is currently establishing the connection. Link is unavailable for now!"),this.link));h(this,"getQrCode",()=>(this.qrCode===""&&this.logger.error("Flottform is currently establishing the connection. qrCode is unavailable for now!"),this.qrCode));h(this,"handleIncomingData",t=>{var e,o,r;if(typeof t.data=="string"){const s=JSON.parse(t.data);s.type==="file-transfer-meta"?(this.filesMetaData=s.filesQueue,this.currentFile={index:0,receivedSize:0,arrayBuffer:[]},this.filesTotalSize=s.totalSize,this.emit("receive")):s.type==="transfer-complete"&&(this.emit("done"),(e=this.channel)==null||e.close())}else if(t.data instanceof ArrayBuffer&&this.currentFile){this.currentFile.arrayBuffer.push(t.data),this.currentFile.receivedSize+=t.data.byteLength,this.receivedDataSize+=t.data.byteLength;const s=(o=this.filesMetaData[this.currentFile.index])==null?void 0:o.name,c=(r=this.filesMetaData[this.currentFile.index])==null?void 0:r.size,a=(this.currentFile.receivedSize/c).toFixed(2),l=(this.receivedDataSize/this.filesTotalSize).toFixed(2);this.emit("progress",{fileIndex:this.currentFile.index,totalFileCount:this.filesMetaData.length,fileName:s,currentFileProgress:parseFloat(a),overallProgress:parseFloat(l)}),this.currentFile.receivedSize===c&&(this.appendFileToInputField(this.currentFile.index),this.currentFile={index:this.currentFile.index+1,receivedSize:0,arrayBuffer:[]})}});h(this,"appendFileToInputField",t=>{var c,a,l,u,m;if(!this.inputField){this.logger.warn("No input field provided!!");return}const e=new DataTransfer;if(this.inputField.files)for(const f of Array.from(this.inputField.files))e.items.add(f);this.inputField.multiple||(this.logger.warn("The host's input field only supports one file. Incoming files from the client will overwrite any existing file, and only the last file received will remain attached."),e.items.clear());const o=(a=(c=this.filesMetaData[t])==null?void 0:c.name)!=null?a:"no-name",r=(u=(l=this.filesMetaData[t])==null?void 0:l.type)!=null?u:"application/octet-stream",s=new File((m=this.currentFile)==null?void 0:m.arrayBuffer,o,{type:r});e.items.add(s),this.inputField.files=e.files});h(this,"registerListeners",()=>{var t,e,o,r,s,c,a;(t=this.channel)==null||t.on("new",()=>{this.emit("new")}),(e=this.channel)==null||e.on("waiting-for-client",l=>{this.emit("webrtc:waiting-for-client",l);const{qrCode:u,link:m}=l;this.emit("endpoint-created",{link:m,qrCode:u}),this.link=m,this.qrCode=u}),(o=this.channel)==null||o.on("waiting-for-ice",()=>{this.emit("webrtc:waiting-for-ice")}),(r=this.channel)==null||r.on("waiting-for-data",()=>{this.emit("webrtc:waiting-for-file"),this.emit("connected")}),(s=this.channel)==null||s.on("receiving-data",l=>{this.handleIncomingData(l)}),(c=this.channel)==null||c.on("disconnected",()=>{this.emit("disconnected")}),(a=this.channel)==null||a.on("error",l=>{this.emit("error",l)})});this.channel=new Ht({flottformApi:t,createClientUrl:e,pollTimeForIceInMs:r,logger:s}),this.inputField=o,this.logger=s,this.registerListeners()}}class qt extends Y{constructor({endpointId:t,flottformApi:e,pollTimeForIceInMs:o=x,logger:r=console}){super();h(this,"flottformApi");h(this,"endpointId");h(this,"rtcConfiguration");h(this,"pollTimeForIceInMs");h(this,"logger");h(this,"state","init");h(this,"openPeerConnection",null);h(this,"dataChannel",null);h(this,"pollForIceTimer",null);h(this,"BUFFER_THRESHOLD",131072);h(this,"changeState",(t,e)=>{this.state=t,this.emit(t,e),this.logger.info(`**Client State changed to: ${t}`,e==null?"":e)});h(this,"start",()=>I(this,null,function*(){this.openPeerConnection&&this.close();const t=(this.flottformApi instanceof URL?this.flottformApi:new URL(this.flottformApi)).toString().replace(/\/$/,"");try{this.rtcConfiguration.iceServers=yield this.fetchIceServers(t)}catch(l){this.logger.error(l)}this.openPeerConnection=new RTCPeerConnection(this.rtcConfiguration);const e=Me(),o=new Set,r=`${this.flottformApi}/${this.endpointId}`,s=`${this.flottformApi}/${this.endpointId}/client`;this.changeState("retrieving-info-from-endpoint");const{hostInfo:c}=yield wt(r);yield this.openPeerConnection.setRemoteDescription(c.session);const a=yield this.openPeerConnection.createAnswer();yield this.openPeerConnection.setLocalDescription(a),this.setUpConnectionStateGathering(r),this.setUpClientIceGathering(s,e,o,a),this.openPeerConnection.ondatachannel=l=>{this.logger.info(`ondatachannel: ${l.channel}`),this.changeState("connected"),this.dataChannel=l.channel,this.dataChannel.bufferedAmountLowThreshold=this.BUFFER_THRESHOLD,this.dataChannel.onbufferedamountlow=()=>{this.emit("bufferedamountlow")},this.dataChannel.onopen=u=>{this.logger.info(`ondatachannel - onopen: ${u.type}`)}},this.changeState("sending-client-info"),yield this.putClientInfo(s,e,o,a),this.changeState("connecting-to-host"),this.startPollingForIceCandidates(r)}));h(this,"close",()=>{this.openPeerConnection&&(this.openPeerConnection.close(),this.openPeerConnection=null),this.changeState("disconnected")});h(this,"sendData",t=>{if(this.dataChannel==null){this.changeState("error","dataChannel is null. Unable to send the file to the Host!");return}else if(!this.canSendMoreData()){this.logger.warn("Data channel is full! Cannot send data at the moment");return}this.dataChannel.send(t)});h(this,"canSendMoreData",()=>this.dataChannel&&this.dataChannel.bufferedAmount<this.dataChannel.bufferedAmountLowThreshold);h(this,"setUpClientIceGathering",(t,e,o,r)=>{if(this.openPeerConnection===null){this.changeState("error","openPeerConnection is null. Unable to gather Client ICE candidates");return}this.openPeerConnection.onicecandidate=s=>I(this,null,function*(){this.logger.info(`onicecandidate - ${this.openPeerConnection.connectionState} - ${s.candidate}`),s.candidate&&(_t(o,s.candidate)||(this.logger.log("client found new ice candidate! Adding it to our list"),o.add(s.candidate),yield this.putClientInfo(t,e,o,r)))}),this.openPeerConnection.onicegatheringstatechange=()=>I(this,null,function*(){this.logger.info(`onicegatheringstatechange - ${this.openPeerConnection.iceGatheringState}`)}),this.openPeerConnection.onicecandidateerror=s=>{this.logger.error(`onicecandidateerror - ${this.openPeerConnection.connectionState}`,s)}});h(this,"setUpConnectionStateGathering",t=>{if(this.openPeerConnection===null){this.changeState("error","openPeerConnection is null. Unable to gather Client ICE candidates");return}this.openPeerConnection.onconnectionstatechange=()=>{this.logger.info(`onconnectionstatechange - ${this.openPeerConnection.connectionState}`),this.openPeerConnection.connectionState==="connected"&&(this.stopPollingForIceCandidates(),this.state==="connecting-to-host"&&this.changeState("connected")),this.openPeerConnection.connectionState==="disconnected"&&this.startPollingForIceCandidates(t),this.openPeerConnection.connectionState==="failed"&&(this.stopPollingForIceCandidates(),this.state!=="done"&&this.changeState("disconnected"))},this.openPeerConnection.oniceconnectionstatechange=()=>{this.logger.info(`oniceconnectionstatechange - ${this.openPeerConnection.iceConnectionState}`),this.openPeerConnection.iceConnectionState==="failed"&&(this.logger.log("Failed to find a possible connection path"),this.changeState("connection-impossible"))}});h(this,"stopPollingForIceCandidates",()=>I(this,null,function*(){this.pollForIceTimer&&clearTimeout(this.pollForIceTimer),this.pollForIceTimer=null}));h(this,"startPollingForIceCandidates",t=>I(this,null,function*(){this.pollForIceTimer&&clearTimeout(this.pollForIceTimer),yield this.pollForConnection(t),this.pollForIceTimer=setTimeout(this.startPollingForIceCandidates,this.pollTimeForIceInMs)}));h(this,"pollForConnection",t=>I(this,null,function*(){if(this.openPeerConnection===null){this.changeState("error","openPeerConnection is null. Unable to retrieve Host's details");return}this.logger.log("polling for host ice candidates",this.openPeerConnection.iceGatheringState);const{hostInfo:e}=yield wt(t);for(const o of e.iceCandidates)yield this.openPeerConnection.addIceCandidate(o)}));h(this,"putClientInfo",(t,e,o,r)=>I(this,null,function*(){if(this.logger.log("Updating client info with new list of ice candidates"),!(yield fetch(t,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({clientKey:e,iceCandidates:[...o],session:r})})).ok)throw Error("Could not update client info. Did another peer already connect?")}));h(this,"fetchIceServers",t=>I(this,null,function*(){const e=yield fetch(`${t}/ice-server-credentials`,{method:"GET",headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Fetching Error!");const o=yield e.json();if(o.success===!1)throw new Error(o.message||"Unknown error occurred");return o.iceServers}));this.endpointId=t,this.flottformApi=e,this.rtcConfiguration=$t,this.pollTimeForIceInMs=o,this.logger=r}}class Ne extends Y{constructor({endpointId:t,fileInput:e,flottformApi:o,pollTimeForIceInMs:r=x,logger:s=console}){super();h(this,"channel",null);h(this,"inputField");h(this,"chunkSize",16384);h(this,"filesMetaData",[]);h(this,"filesArrayBuffer",[]);h(this,"currentFileIndex",0);h(this,"currentChunkIndex",0);h(this,"allFilesSent",!1);h(this,"logger");h(this,"start",()=>{var t;(t=this.channel)==null||t.start()});h(this,"close",()=>{var t;(t=this.channel)==null||t.close()});h(this,"createMetaData",t=>{if(!t.files)return null;const o=Array.from(t.files).map(r=>({name:r.name,type:r.type,size:r.size}));return{type:"file-transfer-meta",filesQueue:o,totalSize:o.reduce((r,s)=>r+s.size,0)}});h(this,"createArrayBuffers",t=>I(this,null,function*(){if(!t.files)return null;const e=Array.from(t.files);return yield Promise.all(e.map(o=>I(this,null,function*(){return yield o.arrayBuffer()})))}));h(this,"sendFiles",()=>I(this,null,function*(){var o;const t=this.createMetaData(this.inputField),e=yield this.createArrayBuffers(this.inputField);if(!t||!e)throw new Error("Can't find the files that you want to send!");this.filesMetaData=t.filesQueue,this.filesArrayBuffer=e,(o=this.channel)==null||o.sendData(JSON.stringify(t)),this.emit("sending"),this.startSendingFiles()}));h(this,"startSendingFiles",()=>{this.sendNextChunk()});h(this,"sendNextChunk",()=>I(this,null,function*(){var s,c,a,l;const t=this.filesMetaData.length;if(this.allFilesSent||this.currentFileIndex>=t){this.logger.log("All files are sent"),(s=this.channel)==null||s.sendData(JSON.stringify({type:"transfer-complete"})),this.allFilesSent=!0,(c=this.channel)==null||c.off("bufferedamountlow",this.startSendingFiles),this.emit("done");return}const e=this.filesArrayBuffer[this.currentFileIndex];if(!e)throw new Error(`Can't find the ArrayBuffer for the file number ${this.currentFileIndex}`);const o=e.byteLength,r=this.filesMetaData[this.currentFileIndex].name;for(;this.currentChunkIndex*this.chunkSize<o;){if(!((a=this.channel)!=null&&a.canSendMoreData())){this.logger.log("Buffer is full. Pausing sending chunks!");break}const u=(this.currentChunkIndex*this.chunkSize/o).toFixed(2);this.emit("progress",{fileIndex:this.currentFileIndex,fileName:r,progress:parseFloat(u)});const m=this.currentChunkIndex*this.chunkSize,f=Math.min((this.currentChunkIndex+1)*this.chunkSize,o);(l=this.channel)==null||l.sendData(e.slice(m,f)),this.currentChunkIndex++}this.currentChunkIndex*this.chunkSize>=o?(this.logger.log(`File ${r} fully sent. Moving to next file.`),this.currentFileIndex++,this.currentChunkIndex=0,this.sendNextChunk()):setTimeout(this.sendNextChunk,100)}));h(this,"registerListeners",()=>{var t,e,o,r,s,c,a,l,u,m;(t=this.channel)==null||t.on("init",()=>{}),(e=this.channel)==null||e.on("retrieving-info-from-endpoint",()=>{}),(o=this.channel)==null||o.on("sending-client-info",()=>{}),(r=this.channel)==null||r.on("connecting-to-host",()=>{}),(s=this.channel)==null||s.on("connected",()=>{this.emit("connected")}),(c=this.channel)==null||c.on("connection-impossible",()=>{this.emit("webrtc:connection-impossible")}),(a=this.channel)==null||a.on("done",()=>{this.emit("done")}),(l=this.channel)==null||l.on("disconnected",()=>{this.emit("disconnected")}),(u=this.channel)==null||u.on("error",f=>{this.emit("error",f)}),(m=this.channel)==null||m.on("bufferedamountlow",this.startSendingFiles)});this.channel=new qt({endpointId:t,flottformApi:o,pollTimeForIceInMs:r,logger:s}),this.inputField=e,this.logger=s,this.registerListeners()}}class ve extends Y{constructor({endpointId:t,flottformApi:e,pollTimeForIceInMs:o=x,logger:r=console}){super();h(this,"channel",null);h(this,"logger");h(this,"start",()=>{var t;(t=this.channel)==null||t.start()});h(this,"close",()=>{var t;(t=this.channel)==null||t.close()});h(this,"sendText",t=>{var e;this.emit("sending"),(e=this.channel)==null||e.sendData(t),this.emit("done")});h(this,"registerListeners",()=>{var t,e,o,r,s,c,a,l,u;(t=this.channel)==null||t.on("init",()=>{}),(e=this.channel)==null||e.on("retrieving-info-from-endpoint",()=>{}),(o=this.channel)==null||o.on("sending-client-info",()=>{}),(r=this.channel)==null||r.on("connecting-to-host",()=>{}),(s=this.channel)==null||s.on("connected",()=>{this.emit("connected")}),(c=this.channel)==null||c.on("connection-impossible",()=>{this.emit("webrtc:connection-impossible")}),(a=this.channel)==null||a.on("done",()=>{this.emit("done")}),(l=this.channel)==null||l.on("disconnected",()=>{this.emit("disconnected")}),(u=this.channel)==null||u.on("error",m=>{this.emit("error",m)})});this.channel=new qt({endpointId:t,flottformApi:e,pollTimeForIceInMs:o,logger:r}),this.logger=r,this.registerListeners()}}class Jt extends zt{constructor({flottformApi:t,createClientUrl:e,pollTimeForIceInMs:o=x,logger:r=console}){super();h(this,"channel",null);h(this,"logger");h(this,"link","");h(this,"qrCode","");h(this,"start",()=>{var t;(t=this.channel)==null||t.start()});h(this,"close",()=>{var t;(t=this.channel)==null||t.close()});h(this,"getLink",()=>(this.link===""&&this.logger.error("Flottform is currently establishing the connection. Link is unavailable for now!"),this.link));h(this,"getQrCode",()=>(this.qrCode===""&&this.logger.error("Flottform is currently establishing the connection. qrCode is unavailable for now!"),this.qrCode));h(this,"handleIncomingData",t=>{this.emit("receive"),this.emit("done",t.data)});h(this,"registerListeners",()=>{var t,e,o,r,s,c,a;(t=this.channel)==null||t.on("new",()=>{this.emit("new")}),(e=this.channel)==null||e.on("waiting-for-client",l=>{this.emit("webrtc:waiting-for-client",l);const{qrCode:u,link:m}=l;this.emit("endpoint-created",{link:m,qrCode:u}),this.link=m,this.qrCode=u}),(o=this.channel)==null||o.on("waiting-for-ice",()=>{this.emit("webrtc:waiting-for-ice")}),(r=this.channel)==null||r.on("waiting-for-data",()=>{this.emit("webrtc:waiting-for-data"),this.emit("connected")}),(s=this.channel)==null||s.on("receiving-data",l=>{this.handleIncomingData(l)}),(c=this.channel)==null||c.on("disconnected",()=>{this.emit("disconnected")}),(a=this.channel)==null||a.on("error",l=>{this.emit("error",l)})});this.channel=new Ht({flottformApi:t,createClientUrl:e,pollTimeForIceInMs:o,logger:r}),this.logger=r,this.registerListeners()}}const De=()=>{const n=document.querySelector(".flottform-elements-container-wrapper"),i=document.querySelector(".flottform-opener-triangle");n.classList.toggle("flottform-open"),i.classList.toggle("flottform-button-svg-open")},ke=(n,i,t)=>{const e=document.createElement("div");e.setAttribute("class",`flottform-root${t!=null?t:""}`);const o=ze(n);e.appendChild(o);const r=He(i);return e.appendChild(r),e},Ue=(n,i)=>{const t=document.createElement("img");t.setAttribute("class","flottform-qr-code"),t.setAttribute("src",n);const e=document.createElement("div");return e.setAttribute("class","flottform-link-offer"),e.innerText=i,{createChannelQrCode:t,createChannelLinkWithOffer:e}},Re=({flottformAnchorElement:n,flottformRootElement:i,additionalComponentClass:t,flottformRootTitle:e,flottformRootDescription:o})=>{var a;const r=(a=i!=null?i:document.querySelector(".flottform-root"))!=null?a:ke(e,o,t),s=r.querySelector(".flottform-elements-container"),c=r.querySelector(".flottform-elements-container-wrapper");return c.appendChild(s),r.appendChild(c),n.appendChild(r),{flottformRoot:r,getAllFlottformItems:()=>{const l=r.querySelector(".flottform-inputs-list");return l?l.childNodes:(console.error("No element with class .flottform-inputs-list found"),null)},createFileItem:({flottformApi:l,createClientUrl:u,inputField:m,id:f,additionalItemClasses:d,label:y,buttonLabel:w,onErrorText:E,onSuccessText:C})=>{const b=new Ot({flottformApi:l,createClientUrl:u,inputField:m}),{flottformItem:g,statusInformation:p,refreshChannelButton:S,flottformStateItemsContainer:F}=Kt({flottformBaseInputHost:b,additionalItemClasses:d,label:y,buttonLabel:w,onErrorText:E}),A=r.querySelector(".flottform-inputs-list");A.appendChild(g),s.appendChild(A),$e({flottformItem:g,statusInformation:p,refreshChannelButton:S,flottformStateItemsContainer:F,flottformFileInputHost:b,id:f,onSuccessText:C})},createTextItem:({flottformApi:l,createClientUrl:u,inputField:m,id:f,additionalItemClasses:d,label:y,buttonLabel:w,onErrorText:E,onSuccessText:C})=>{const b=new Jt({flottformApi:l,createClientUrl:u}),{flottformItem:g,statusInformation:p,refreshChannelButton:S}=Kt({flottformBaseInputHost:b,additionalItemClasses:d,label:y,buttonLabel:w,onErrorText:E}),F=r.querySelector(".flottform-inputs-list");F.appendChild(g),s.appendChild(F),_e({flottformItem:g,statusInformation:p,refreshChannelButton:S,flottformTextInputHost:b,id:f,onSuccessText:C,inputField:m})}}},Kt=({flottformBaseInputHost:n,additionalItemClasses:i,label:t,buttonLabel:e,onErrorText:o})=>{const r=Oe(i);je({label:t,flottformItem:r});const s=qe(),c=Ke(e);c.addEventListener("click",()=>n.start());const a=Je(c);r.appendChild(a);const l=Ge();return l.addEventListener("click",()=>n.start()),n.on("endpoint-created",({link:u,qrCode:m})=>{const{createChannelQrCode:f,createChannelLinkWithOffer:d}=Ue(m,u),y=xe();a.replaceChildren(f);const w=document.createElement("div");w.setAttribute("class","flottform-copy-button-link-wrapper"),w.appendChild(y),w.appendChild(d),a.appendChild(w)}),n.on("connected",()=>{s.innerHTML="Connected",s.appendChild(l),a.replaceChildren(s)}),n.on("error",u=>{s.innerHTML=typeof o=="function"?o(u):o!=null?o:`🚨 An error occured (${u.message}). Please try again`,c.innerText="Retry",a.replaceChildren(s),a.appendChild(c)}),{flottformItem:r,statusInformation:s,refreshChannelButton:l,flottformStateItemsContainer:a}},$e=({flottformItem:n,statusInformation:i,refreshChannelButton:t,flottformStateItemsContainer:e,flottformFileInputHost:o,id:r,onSuccessText:s})=>{r&&n.setAttribute("id",r),o.on("progress",({currentFileProgress:c,overallProgress:a,fileIndex:l,totalFileCount:u,fileName:m})=>{Ye(e),tn(e,a,l,u);const f=Qe(e);Ze(l,m,c,f,e)}),o.on("done",()=>{i.innerHTML=s!=null?s:"✨ You have succesfully downloaded all your files.",i.appendChild(t),e.replaceChildren(i)})},_e=({flottformItem:n,statusInformation:i,refreshChannelButton:t,flottformTextInputHost:e,id:o,onSuccessText:r,inputField:s})=>{o&&n.setAttribute("id",o),e.on("done",c=>{if(i.innerHTML=r!=null?r:"✨ You have succesfully submitted your message",i.appendChild(t),n.replaceChildren(i),s){s.setAttribute("value",c);const a=new Event("change");s.dispatchEvent(a)}})},ze=n=>{const i=document.createElement("button");return i.setAttribute("type","button"),i.setAttribute("class","flottform-root-opener-button"),i.innerHTML=`<span>${n!=null?n:"Fill from Another Device"}</span><svg class="flottform-opener-triangle" width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M6.5,8.5l6,7l6-7H6.5z"/></svg>`,i.addEventListener("click",()=>De()),i},He=n=>{const i=document.createElement("div");i.setAttribute("class","flottform-elements-container");const t=document.createElement("div");if(t.setAttribute("class","flottform-elements-container-wrapper"),n!==""){const o=document.createElement("div");o.setAttribute("class","flottform-root-description"),o.innerText=n!=null?n:"This form is powered by Flottform. Need to add details from another device? Simply click a button below to generate a QR code or link, and easily upload information from your other device.",i.appendChild(o)}const e=document.createElement("ul");return e.setAttribute("class","flottform-inputs-list"),i.appendChild(e),t.appendChild(i),t},Oe=n=>{const i=document.createElement("li");return i.setAttribute("class",`flottform-item${n!=null?n:""}`),i},qe=()=>{const n=document.createElement("div");return n.setAttribute("class","flottform-status-information"),n},Je=n=>{const i=document.createElement("div");return i.setAttribute("class","flottform-state-items-container"),i.appendChild(n),i},Ke=n=>{const i=document.createElement("button");return i.setAttribute("type","button"),i.setAttribute("class","flottform-button"),i.innerText=n!=null?n:"Get a link",i},Ge=()=>{const n=document.createElement("button");return n.setAttribute("type","button"),n.setAttribute("class","flottform-refresh-connection-button"),n.setAttribute("title","Click this button to refresh Flottform connection for the input field. Previous connection will be closed"),n.setAttribute("aria-label","Click this button to refresh Flottform connection for the input field. Previous connection will be closed"),n.innerHTML='<svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M13.5 2c-5.288 0-9.649 3.914-10.377 9h-3.123l4 5.917 4-5.917h-2.847c.711-3.972 4.174-7 8.347-7 4.687 0 8.5 3.813 8.5 8.5s-3.813 8.5-8.5 8.5c-3.015 0-5.662-1.583-7.171-3.957l-1.2 1.775c1.916 2.536 4.948 4.182 8.371 4.182 5.797 0 10.5-4.702 10.5-10.5s-4.703-10.5-10.5-10.5z"/></svg>',n};let Ve=1;const je=({label:n,flottformItem:i})=>{const t=document.createElement("p"),e=n!=null?n:`File input ${Ve++}`;e&&(t.innerHTML=e,i.appendChild(t))},xe=()=>{const n=document.createElement("button");return n.setAttribute("class","flottform-copy-to-clipboard"),n.setAttribute("type","button"),n.setAttribute("title","Copy Flottform link to clipboard"),n.setAttribute("aria-label","Copy Flottform link to clipboard"),n.innerText="📋",n.addEventListener("click",()=>I(this,null,function*(){const i=document.querySelector(".flottform-link-offer").innerText;navigator.clipboard.writeText(i).then(()=>{n.innerText="✅",setTimeout(()=>{n.innerText="📋"},1e3)}).catch(t=>{n.innerText=`❌ Failed to copy: ${t}`,setTimeout(()=>{n.innerText="📋"},1e3)})})),n},Ye=n=>{n.querySelector(".flottform-status-information")&&(n.innerHTML="")},Qe=n=>{let i=n.querySelector("details");if(!i){i=document.createElement("details");const t=document.createElement("summary");t.innerText="Details",i.appendChild(t);const e=document.createElement("div");e.classList.add("details-container"),i.appendChild(e),n.appendChild(i)}return i},We=(n,i)=>{const t=document.createElement("label");t.setAttribute("id",`flottform-status-bar-${n}`),t.classList.add("flottform-progress-bar-label"),t.innerText=`File ${i} progress:`;const e=document.createElement("progress");return e.setAttribute("id",`flottform-status-bar-${n}`),e.classList.add("flottform-status-bar"),e.setAttribute("max","100"),e.setAttribute("value","0"),{currentFileLabel:t,progressBar:e}},Ze=(n,i,t,e,o)=>{let r=o.querySelector(`progress#flottform-status-bar-${n}`);if(!r){const{currentFileLabel:s,progressBar:c}=We(n,i);r=c;const a=e.querySelector(".details-container");a.appendChild(s),a.appendChild(r)}r.value=t*100,r.innerText=`${t*100}%`},Xe=()=>{const n=document.createElement("label");n.setAttribute("id","flottform-status-bar-overall-progress"),n.classList.add("flottform-progress-bar-label"),n.innerText="Receiving Files Progress";const i=document.createElement("progress");return i.setAttribute("id","flottform-status-bar-overall-progress"),i.classList.add("flottform-status-bar"),i.setAttribute("max","100"),i.setAttribute("value","0"),{overallFilesLabel:n,progressBar:i}},tn=(n,i,t,e)=>{let o=n.querySelector("progress#flottform-status-bar-overall-progress");if(!o){const{overallFilesLabel:s,progressBar:c}=Xe();o=c,n.appendChild(s),n.appendChild(o)}const r=n.querySelector("label#flottform-status-bar-overall-progress");o.value=i*100,o.innerText=`${i*100}%`,r.innerText=`Receiving file ${t+1} of ${e}`};return P.FlottformFileInputClient=Ne,P.FlottformFileInputHost=Ot,P.FlottformTextInputClient=ve,P.FlottformTextInputHost=Jt,P.createDefaultFlottformComponent=Re,Object.defineProperty(P,Symbol.toStringTag,{value:"Module"}),P}({});
//# sourceMappingURL=content-script.js.map
