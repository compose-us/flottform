var FlottForm=function(A){"use strict";var en=Object.defineProperty;var nn=(A,L,B)=>L in A?en(A,L,{enumerable:!0,configurable:!0,writable:!0,value:B}):A[L]=B;var h=(A,L,B)=>nn(A,typeof L!="symbol"?L+"":L,B);var S=(A,L,B)=>new Promise((P,z)=>{var it=D=>{try{O(B.next(D))}catch(k){z(k)}},H=D=>{try{O(B.throw(D))}catch(k){z(k)}},O=D=>D.done?P(D.value):Promise.resolve(D.value).then(it,H);O((B=B.apply(A,L)).next())});var L=function(){return typeof Promise=="function"&&Promise.prototype&&Promise.prototype.then},B={},P={};let z;const it=[0,26,44,70,100,134,172,196,242,292,346,404,466,532,581,655,733,815,901,991,1085,1156,1258,1364,1474,1588,1706,1828,1921,2051,2185,2323,2465,2611,2761,2876,3034,3196,3362,3532,3706];P.getSymbolSize=function(o){if(!o)throw new Error('"version" cannot be null or undefined');if(o<1||o>40)throw new Error('"version" should be in range from 1 to 40');return o*4+17},P.getSymbolTotalCodewords=function(o){return it[o]},P.getBCHDigit=function(n){let o=0;for(;n!==0;)o++,n>>>=1;return o},P.setToSJISFunction=function(o){if(typeof o!="function")throw new Error('"toSJISFunc" is not a valid function.');z=o},P.isKanjiModeEnabled=function(){return typeof z!="undefined"},P.toSJIS=function(o){return z(o)};var H={};(function(n){n.L={bit:1},n.M={bit:0},n.Q={bit:3},n.H={bit:2};function o(t){if(typeof t!="string")throw new Error("Param is not a string");switch(t.toLowerCase()){case"l":case"low":return n.L;case"m":case"medium":return n.M;case"q":case"quartile":return n.Q;case"h":case"high":return n.H;default:throw new Error("Unknown EC Level: "+t)}}n.isValid=function(e){return e&&typeof e.bit!="undefined"&&e.bit>=0&&e.bit<4},n.from=function(e,i){if(n.isValid(e))return e;try{return o(e)}catch(r){return i}}})(H);function O(){this.buffer=[],this.length=0}O.prototype={get:function(n){const o=Math.floor(n/8);return(this.buffer[o]>>>7-n%8&1)===1},put:function(n,o){for(let t=0;t<o;t++)this.putBit((n>>>o-t-1&1)===1)},getLengthInBits:function(){return this.length},putBit:function(n){const o=Math.floor(this.length/8);this.buffer.length<=o&&this.buffer.push(0),n&&(this.buffer[o]|=128>>>this.length%8),this.length++}};var D=O;function k(n){if(!n||n<1)throw new Error("BitMatrix size must be defined and greater than 0");this.size=n,this.data=new Uint8Array(n*n),this.reservedBit=new Uint8Array(n*n)}k.prototype.set=function(n,o,t,e){const i=n*this.size+o;this.data[i]=t,e&&(this.reservedBit[i]=!0)},k.prototype.get=function(n,o){return this.data[n*this.size+o]},k.prototype.xor=function(n,o,t){this.data[n*this.size+o]^=t},k.prototype.isReserved=function(n,o){return this.reservedBit[n*this.size+o]};var Kt=k,bt={};(function(n){const o=P.getSymbolSize;n.getRowColCoords=function(e){if(e===1)return[];const i=Math.floor(e/7)+2,r=o(e),s=r===145?26:Math.ceil((r-13)/(2*i-2))*2,c=[r-7];for(let a=1;a<i-1;a++)c[a]=c[a-1]-s;return c.push(6),c.reverse()},n.getPositions=function(e){const i=[],r=n.getRowColCoords(e),s=r.length;for(let c=0;c<s;c++)for(let a=0;a<s;a++)c===0&&a===0||c===0&&a===s-1||c===s-1&&a===0||i.push([r[c],r[a]]);return i}})(bt);var Ft={};const Gt=P.getSymbolSize,It=7;Ft.getPositions=function(o){const t=Gt(o);return[[0,0],[t-It,0],[0,t-It]]};var St={};(function(n){n.Patterns={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};const o={N1:3,N2:3,N3:40,N4:10};n.isValid=function(i){return i!=null&&i!==""&&!isNaN(i)&&i>=0&&i<=7},n.from=function(i){return n.isValid(i)?parseInt(i,10):void 0},n.getPenaltyN1=function(i){const r=i.size;let s=0,c=0,a=0,l=null,u=null;for(let m=0;m<r;m++){c=a=0,l=u=null;for(let f=0;f<r;f++){let d=i.get(m,f);d===l?c++:(c>=5&&(s+=o.N1+(c-5)),l=d,c=1),d=i.get(f,m),d===u?a++:(a>=5&&(s+=o.N1+(a-5)),u=d,a=1)}c>=5&&(s+=o.N1+(c-5)),a>=5&&(s+=o.N1+(a-5))}return s},n.getPenaltyN2=function(i){const r=i.size;let s=0;for(let c=0;c<r-1;c++)for(let a=0;a<r-1;a++){const l=i.get(c,a)+i.get(c,a+1)+i.get(c+1,a)+i.get(c+1,a+1);(l===4||l===0)&&s++}return s*o.N2},n.getPenaltyN3=function(i){const r=i.size;let s=0,c=0,a=0;for(let l=0;l<r;l++){c=a=0;for(let u=0;u<r;u++)c=c<<1&2047|i.get(l,u),u>=10&&(c===1488||c===93)&&s++,a=a<<1&2047|i.get(u,l),u>=10&&(a===1488||a===93)&&s++}return s*o.N3},n.getPenaltyN4=function(i){let r=0;const s=i.data.length;for(let a=0;a<s;a++)r+=i.data[a];return Math.abs(Math.ceil(r*100/s/5)-10)*o.N4};function t(e,i,r){switch(e){case n.Patterns.PATTERN000:return(i+r)%2===0;case n.Patterns.PATTERN001:return i%2===0;case n.Patterns.PATTERN010:return r%3===0;case n.Patterns.PATTERN011:return(i+r)%3===0;case n.Patterns.PATTERN100:return(Math.floor(i/2)+Math.floor(r/3))%2===0;case n.Patterns.PATTERN101:return i*r%2+i*r%3===0;case n.Patterns.PATTERN110:return(i*r%2+i*r%3)%2===0;case n.Patterns.PATTERN111:return(i*r%3+(i+r)%2)%2===0;default:throw new Error("bad maskPattern:"+e)}}n.applyMask=function(i,r){const s=r.size;for(let c=0;c<s;c++)for(let a=0;a<s;a++)r.isReserved(a,c)||r.xor(a,c,t(i,a,c))},n.getBestMask=function(i,r){const s=Object.keys(n.Patterns).length;let c=0,a=1/0;for(let l=0;l<s;l++){r(l),n.applyMask(l,i);const u=n.getPenaltyN1(i)+n.getPenaltyN2(i)+n.getPenaltyN3(i)+n.getPenaltyN4(i);n.applyMask(l,i),u<a&&(a=u,c=l)}return c}})(St);var W={};const U=H,Z=[1,1,1,1,1,1,1,1,1,1,2,2,1,2,2,4,1,2,4,4,2,4,4,4,2,4,6,5,2,4,6,6,2,5,8,8,4,5,8,8,4,5,8,11,4,8,10,11,4,9,12,16,4,9,16,16,6,10,12,18,6,10,17,16,6,11,16,19,6,13,18,21,7,14,21,25,8,16,20,25,8,17,23,25,9,17,23,34,9,18,25,30,10,20,27,32,12,21,29,35,12,23,34,37,12,25,34,40,13,26,35,42,14,28,38,45,15,29,40,48,16,31,43,51,17,33,45,54,18,35,48,57,19,37,51,60,19,38,53,63,20,40,56,66,21,43,59,70,22,45,62,74,24,47,65,77,25,49,68,81],X=[7,10,13,17,10,16,22,28,15,26,36,44,20,36,52,64,26,48,72,88,36,64,96,112,40,72,108,130,48,88,132,156,60,110,160,192,72,130,192,224,80,150,224,264,96,176,260,308,104,198,288,352,120,216,320,384,132,240,360,432,144,280,408,480,168,308,448,532,180,338,504,588,196,364,546,650,224,416,600,700,224,442,644,750,252,476,690,816,270,504,750,900,300,560,810,960,312,588,870,1050,336,644,952,1110,360,700,1020,1200,390,728,1050,1260,420,784,1140,1350,450,812,1200,1440,480,868,1290,1530,510,924,1350,1620,540,980,1440,1710,570,1036,1530,1800,570,1064,1590,1890,600,1120,1680,1980,630,1204,1770,2100,660,1260,1860,2220,720,1316,1950,2310,750,1372,2040,2430];W.getBlocksCount=function(o,t){switch(t){case U.L:return Z[(o-1)*4+0];case U.M:return Z[(o-1)*4+1];case U.Q:return Z[(o-1)*4+2];case U.H:return Z[(o-1)*4+3];default:return}},W.getTotalCodewordsCount=function(o,t){switch(t){case U.L:return X[(o-1)*4+0];case U.M:return X[(o-1)*4+1];case U.Q:return X[(o-1)*4+2];case U.H:return X[(o-1)*4+3];default:return}};var Et={},tt={};const G=new Uint8Array(512),et=new Uint8Array(256);(function(){let o=1;for(let t=0;t<255;t++)G[t]=o,et[o]=t,o<<=1,o&256&&(o^=285);for(let t=255;t<512;t++)G[t]=G[t-255]})(),tt.log=function(o){if(o<1)throw new Error("log("+o+")");return et[o]},tt.exp=function(o){return G[o]},tt.mul=function(o,t){return o===0||t===0?0:G[et[o]+et[t]]},function(n){const o=tt;n.mul=function(e,i){const r=new Uint8Array(e.length+i.length-1);for(let s=0;s<e.length;s++)for(let c=0;c<i.length;c++)r[s+c]^=o.mul(e[s],i[c]);return r},n.mod=function(e,i){let r=new Uint8Array(e);for(;r.length-i.length>=0;){const s=r[0];for(let a=0;a<i.length;a++)r[a]^=o.mul(i[a],s);let c=0;for(;c<r.length&&r[c]===0;)c++;r=r.slice(c)}return r},n.generateECPolynomial=function(e){let i=new Uint8Array([1]);for(let r=0;r<e;r++)i=n.mul(i,new Uint8Array([1,o.exp(r)]));return i}}(Et);const Tt=Et;function rt(n){this.genPoly=void 0,this.degree=n,this.degree&&this.initialize(this.degree)}rt.prototype.initialize=function(o){this.degree=o,this.genPoly=Tt.generateECPolynomial(this.degree)},rt.prototype.encode=function(o){if(!this.genPoly)throw new Error("Encoder not initialized");const t=new Uint8Array(o.length+this.degree);t.set(o);const e=Tt.mod(t,this.genPoly),i=this.degree-e.length;if(i>0){const r=new Uint8Array(this.degree);return r.set(e,i),r}return e};var Vt=rt,At={},$={},st={};st.isValid=function(o){return!isNaN(o)&&o>=1&&o<=40};var v={};const Pt="[0-9]+",jt="[A-Z $%*+\\-./:]+";let V="(?:[u3000-u303F]|[u3040-u309F]|[u30A0-u30FF]|[uFF00-uFFEF]|[u4E00-u9FAF]|[u2605-u2606]|[u2190-u2195]|u203B|[u2010u2015u2018u2019u2025u2026u201Cu201Du2225u2260]|[u0391-u0451]|[u00A7u00A8u00B1u00B4u00D7u00F7])+";V=V.replace(/u/g,"\\u");const Yt="(?:(?![A-Z0-9 $%*+\\-./:]|"+V+`)(?:.|[\r
]))+`;v.KANJI=new RegExp(V,"g"),v.BYTE_KANJI=new RegExp("[^A-Z0-9 $%*+\\-./:]+","g"),v.BYTE=new RegExp(Yt,"g"),v.NUMERIC=new RegExp(Pt,"g"),v.ALPHANUMERIC=new RegExp(jt,"g");const Qt=new RegExp("^"+V+"$"),Wt=new RegExp("^"+Pt+"$"),Zt=new RegExp("^[A-Z0-9 $%*+\\-./:]+$");v.testKanji=function(o){return Qt.test(o)},v.testNumeric=function(o){return Wt.test(o)},v.testAlphanumeric=function(o){return Zt.test(o)},function(n){const o=st,t=v;n.NUMERIC={id:"Numeric",bit:1,ccBits:[10,12,14]},n.ALPHANUMERIC={id:"Alphanumeric",bit:2,ccBits:[9,11,13]},n.BYTE={id:"Byte",bit:4,ccBits:[8,16,16]},n.KANJI={id:"Kanji",bit:8,ccBits:[8,10,12]},n.MIXED={bit:-1},n.getCharCountIndicator=function(r,s){if(!r.ccBits)throw new Error("Invalid mode: "+r);if(!o.isValid(s))throw new Error("Invalid version: "+s);return s>=1&&s<10?r.ccBits[0]:s<27?r.ccBits[1]:r.ccBits[2]},n.getBestModeForData=function(r){return t.testNumeric(r)?n.NUMERIC:t.testAlphanumeric(r)?n.ALPHANUMERIC:t.testKanji(r)?n.KANJI:n.BYTE},n.toString=function(r){if(r&&r.id)return r.id;throw new Error("Invalid mode")},n.isValid=function(r){return r&&r.bit&&r.ccBits};function e(i){if(typeof i!="string")throw new Error("Param is not a string");switch(i.toLowerCase()){case"numeric":return n.NUMERIC;case"alphanumeric":return n.ALPHANUMERIC;case"kanji":return n.KANJI;case"byte":return n.BYTE;default:throw new Error("Unknown mode: "+i)}}n.from=function(r,s){if(n.isValid(r))return r;try{return e(r)}catch(c){return s}}}($),function(n){const o=P,t=W,e=H,i=$,r=st,s=7973,c=o.getBCHDigit(s);function a(f,d,y){for(let w=1;w<=40;w++)if(d<=n.getCapacity(w,y,f))return w}function l(f,d){return i.getCharCountIndicator(f,d)+4}function u(f,d){let y=0;return f.forEach(function(w){const E=l(w.mode,d);y+=E+w.getBitsLength()}),y}function m(f,d){for(let y=1;y<=40;y++)if(u(f,y)<=n.getCapacity(y,d,i.MIXED))return y}n.from=function(d,y){return r.isValid(d)?parseInt(d,10):y},n.getCapacity=function(d,y,w){if(!r.isValid(d))throw new Error("Invalid QR Code version");typeof w=="undefined"&&(w=i.BYTE);const E=o.getSymbolTotalCodewords(d),C=t.getTotalCodewordsCount(d,y),b=(E-C)*8;if(w===i.MIXED)return b;const g=b-l(w,d);switch(w){case i.NUMERIC:return Math.floor(g/10*3);case i.ALPHANUMERIC:return Math.floor(g/11*2);case i.KANJI:return Math.floor(g/13);case i.BYTE:default:return Math.floor(g/8)}},n.getBestVersionForData=function(d,y){let w;const E=e.from(y,e.M);if(Array.isArray(d)){if(d.length>1)return m(d,E);if(d.length===0)return 1;w=d[0]}else w=d;return a(w.mode,w.getLength(),E)},n.getEncodedBits=function(d){if(!r.isValid(d)||d<7)throw new Error("Invalid QR Code version");let y=d<<12;for(;o.getBCHDigit(y)-c>=0;)y^=s<<o.getBCHDigit(y)-c;return d<<12|y}}(At);var Bt={};const at=P,Lt=1335,Xt=21522,Mt=at.getBCHDigit(Lt);Bt.getEncodedBits=function(o,t){const e=o.bit<<3|t;let i=e<<10;for(;at.getBCHDigit(i)-Mt>=0;)i^=Lt<<at.getBCHDigit(i)-Mt;return(e<<10|i)^Xt};var vt={};const te=$;function q(n){this.mode=te.NUMERIC,this.data=n.toString()}q.getBitsLength=function(o){return 10*Math.floor(o/3)+(o%3?o%3*3+1:0)},q.prototype.getLength=function(){return this.data.length},q.prototype.getBitsLength=function(){return q.getBitsLength(this.data.length)},q.prototype.write=function(o){let t,e,i;for(t=0;t+3<=this.data.length;t+=3)e=this.data.substr(t,3),i=parseInt(e,10),o.put(i,10);const r=this.data.length-t;r>0&&(e=this.data.substr(t),i=parseInt(e,10),o.put(i,r*3+1))};var ee=q;const ne=$,ct=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"," ","$","%","*","+","-",".","/",":"];function J(n){this.mode=ne.ALPHANUMERIC,this.data=n}J.getBitsLength=function(o){return 11*Math.floor(o/2)+6*(o%2)},J.prototype.getLength=function(){return this.data.length},J.prototype.getBitsLength=function(){return J.getBitsLength(this.data.length)},J.prototype.write=function(o){let t;for(t=0;t+2<=this.data.length;t+=2){let e=ct.indexOf(this.data[t])*45;e+=ct.indexOf(this.data[t+1]),o.put(e,11)}this.data.length%2&&o.put(ct.indexOf(this.data[t]),6)};var oe=J;const ie=$;function x(n){this.mode=ie.BYTE,typeof n=="string"?this.data=new TextEncoder().encode(n):this.data=new Uint8Array(n)}x.getBitsLength=function(o){return o*8},x.prototype.getLength=function(){return this.data.length},x.prototype.getBitsLength=function(){return x.getBitsLength(this.data.length)},x.prototype.write=function(n){for(let o=0,t=this.data.length;o<t;o++)n.put(this.data[o],8)};var re=x;const se=$,ae=P;function K(n){this.mode=se.KANJI,this.data=n}K.getBitsLength=function(o){return o*13},K.prototype.getLength=function(){return this.data.length},K.prototype.getBitsLength=function(){return K.getBitsLength(this.data.length)},K.prototype.write=function(n){let o;for(o=0;o<this.data.length;o++){let t=ae.toSJIS(this.data[o]);if(t>=33088&&t<=40956)t-=33088;else if(t>=57408&&t<=60351)t-=49472;else throw new Error("Invalid SJIS character: "+this.data[o]+`
Make sure your charset is UTF-8`);t=(t>>>8&255)*192+(t&255),n.put(t,13)}};var ce=K,Nt={exports:{}};(function(n){var o={single_source_shortest_paths:function(t,e,i){var r={},s={};s[e]=0;var c=o.PriorityQueue.make();c.push(e,0);for(var a,l,u,m,f,d,y,w,E;!c.empty();){a=c.pop(),l=a.value,m=a.cost,f=t[l]||{};for(u in f)f.hasOwnProperty(u)&&(d=f[u],y=m+d,w=s[u],E=typeof s[u]=="undefined",(E||w>y)&&(s[u]=y,c.push(u,y),r[u]=l))}if(typeof i!="undefined"&&typeof s[i]=="undefined"){var C=["Could not find a path from ",e," to ",i,"."].join("");throw new Error(C)}return r},extract_shortest_path_from_predecessor_list:function(t,e){for(var i=[],r=e;r;)i.push(r),t[r],r=t[r];return i.reverse(),i},find_path:function(t,e,i){var r=o.single_source_shortest_paths(t,e,i);return o.extract_shortest_path_from_predecessor_list(r,i)},PriorityQueue:{make:function(t){var e=o.PriorityQueue,i={},r;t=t||{};for(r in e)e.hasOwnProperty(r)&&(i[r]=e[r]);return i.queue=[],i.sorter=t.sorter||e.default_sorter,i},default_sorter:function(t,e){return t.cost-e.cost},push:function(t,e){var i={value:t,cost:e};this.queue.push(i),this.queue.sort(this.sorter)},pop:function(){return this.queue.shift()},empty:function(){return this.queue.length===0}}};n.exports=o})(Nt);var le=Nt.exports;(function(n){const o=$,t=ee,e=oe,i=re,r=ce,s=v,c=P,a=le;function l(C){return unescape(encodeURIComponent(C)).length}function u(C,b,g){const p=[];let F;for(;(F=C.exec(g))!==null;)p.push({data:F[0],index:F.index,mode:b,length:F[0].length});return p}function m(C){const b=u(s.NUMERIC,o.NUMERIC,C),g=u(s.ALPHANUMERIC,o.ALPHANUMERIC,C);let p,F;return c.isKanjiModeEnabled()?(p=u(s.BYTE,o.BYTE,C),F=u(s.KANJI,o.KANJI,C)):(p=u(s.BYTE_KANJI,o.BYTE,C),F=[]),b.concat(g,p,F).sort(function(T,M){return T.index-M.index}).map(function(T){return{data:T.data,mode:T.mode,length:T.length}})}function f(C,b){switch(b){case o.NUMERIC:return t.getBitsLength(C);case o.ALPHANUMERIC:return e.getBitsLength(C);case o.KANJI:return r.getBitsLength(C);case o.BYTE:return i.getBitsLength(C)}}function d(C){return C.reduce(function(b,g){const p=b.length-1>=0?b[b.length-1]:null;return p&&p.mode===g.mode?(b[b.length-1].data+=g.data,b):(b.push(g),b)},[])}function y(C){const b=[];for(let g=0;g<C.length;g++){const p=C[g];switch(p.mode){case o.NUMERIC:b.push([p,{data:p.data,mode:o.ALPHANUMERIC,length:p.length},{data:p.data,mode:o.BYTE,length:p.length}]);break;case o.ALPHANUMERIC:b.push([p,{data:p.data,mode:o.BYTE,length:p.length}]);break;case o.KANJI:b.push([p,{data:p.data,mode:o.BYTE,length:l(p.data)}]);break;case o.BYTE:b.push([{data:p.data,mode:o.BYTE,length:l(p.data)}])}}return b}function w(C,b){const g={},p={start:{}};let F=["start"];for(let I=0;I<C.length;I++){const T=C[I],M=[];for(let _=0;_<T.length;_++){const N=T[_],Q=""+I+_;M.push(Q),g[Q]={node:N,lastCount:0},p[Q]={};for(let yt=0;yt<F.length;yt++){const R=F[yt];g[R]&&g[R].node.mode===N.mode?(p[R][Q]=f(g[R].lastCount+N.length,N.mode)-f(g[R].lastCount,N.mode),g[R].lastCount+=N.length):(g[R]&&(g[R].lastCount=N.length),p[R][Q]=f(N.length,N.mode)+4+o.getCharCountIndicator(N.mode,b))}}F=M}for(let I=0;I<F.length;I++)p[F[I]].end=0;return{map:p,table:g}}function E(C,b){let g;const p=o.getBestModeForData(C);if(g=o.from(b,p),g!==o.BYTE&&g.bit<p.bit)throw new Error('"'+C+'" cannot be encoded with mode '+o.toString(g)+`.
 Suggested mode is: `+o.toString(p));switch(g===o.KANJI&&!c.isKanjiModeEnabled()&&(g=o.BYTE),g){case o.NUMERIC:return new t(C);case o.ALPHANUMERIC:return new e(C);case o.KANJI:return new r(C);case o.BYTE:return new i(C)}}n.fromArray=function(b){return b.reduce(function(g,p){return typeof p=="string"?g.push(E(p,null)):p.data&&g.push(E(p.data,p.mode)),g},[])},n.fromString=function(b,g){const p=m(b,c.isKanjiModeEnabled()),F=y(p),I=w(F,g),T=a.find_path(I.map,"start","end"),M=[];for(let _=1;_<T.length-1;_++)M.push(I.table[T[_]].node);return n.fromArray(d(M))},n.rawSplit=function(b){return n.fromArray(m(b,c.isKanjiModeEnabled()))}})(vt);const nt=P,lt=H,he=D,ue=Kt,fe=bt,de=Ft,ht=St,ut=W,ge=Vt,ot=At,pe=Bt,me=$,ft=vt;function Ce(n,o){const t=n.size,e=de.getPositions(o);for(let i=0;i<e.length;i++){const r=e[i][0],s=e[i][1];for(let c=-1;c<=7;c++)if(!(r+c<=-1||t<=r+c))for(let a=-1;a<=7;a++)s+a<=-1||t<=s+a||(c>=0&&c<=6&&(a===0||a===6)||a>=0&&a<=6&&(c===0||c===6)||c>=2&&c<=4&&a>=2&&a<=4?n.set(r+c,s+a,!0,!0):n.set(r+c,s+a,!1,!0))}}function we(n){const o=n.size;for(let t=8;t<o-8;t++){const e=t%2===0;n.set(t,6,e,!0),n.set(6,t,e,!0)}}function ye(n,o){const t=fe.getPositions(o);for(let e=0;e<t.length;e++){const i=t[e][0],r=t[e][1];for(let s=-2;s<=2;s++)for(let c=-2;c<=2;c++)s===-2||s===2||c===-2||c===2||s===0&&c===0?n.set(i+s,r+c,!0,!0):n.set(i+s,r+c,!1,!0)}}function be(n,o){const t=n.size,e=ot.getEncodedBits(o);let i,r,s;for(let c=0;c<18;c++)i=Math.floor(c/3),r=c%3+t-8-3,s=(e>>c&1)===1,n.set(i,r,s,!0),n.set(r,i,s,!0)}function dt(n,o,t){const e=n.size,i=pe.getEncodedBits(o,t);let r,s;for(r=0;r<15;r++)s=(i>>r&1)===1,r<6?n.set(r,8,s,!0):r<8?n.set(r+1,8,s,!0):n.set(e-15+r,8,s,!0),r<8?n.set(8,e-r-1,s,!0):r<9?n.set(8,15-r-1+1,s,!0):n.set(8,15-r-1,s,!0);n.set(e-8,8,1,!0)}function Fe(n,o){const t=n.size;let e=-1,i=t-1,r=7,s=0;for(let c=t-1;c>0;c-=2)for(c===6&&c--;;){for(let a=0;a<2;a++)if(!n.isReserved(i,c-a)){let l=!1;s<o.length&&(l=(o[s]>>>r&1)===1),n.set(i,c-a,l),r--,r===-1&&(s++,r=7)}if(i+=e,i<0||t<=i){i-=e,e=-e;break}}}function Ie(n,o,t){const e=new he;t.forEach(function(a){e.put(a.mode.bit,4),e.put(a.getLength(),me.getCharCountIndicator(a.mode,n)),a.write(e)});const i=nt.getSymbolTotalCodewords(n),r=ut.getTotalCodewordsCount(n,o),s=(i-r)*8;for(e.getLengthInBits()+4<=s&&e.put(0,4);e.getLengthInBits()%8!==0;)e.putBit(0);const c=(s-e.getLengthInBits())/8;for(let a=0;a<c;a++)e.put(a%2?17:236,8);return Se(e,n,o)}function Se(n,o,t){const e=nt.getSymbolTotalCodewords(o),i=ut.getTotalCodewordsCount(o,t),r=e-i,s=ut.getBlocksCount(o,t),c=e%s,a=s-c,l=Math.floor(e/s),u=Math.floor(r/s),m=u+1,f=l-u,d=new ge(f);let y=0;const w=new Array(s),E=new Array(s);let C=0;const b=new Uint8Array(n.buffer);for(let T=0;T<s;T++){const M=T<a?u:m;w[T]=b.slice(y,y+M),E[T]=d.encode(w[T]),y+=M,C=Math.max(C,M)}const g=new Uint8Array(e);let p=0,F,I;for(F=0;F<C;F++)for(I=0;I<s;I++)F<w[I].length&&(g[p++]=w[I][F]);for(F=0;F<f;F++)for(I=0;I<s;I++)g[p++]=E[I][F];return g}function Ee(n,o,t,e){let i;if(Array.isArray(n))i=ft.fromArray(n);else if(typeof n=="string"){let l=o;if(!l){const u=ft.rawSplit(n);l=ot.getBestVersionForData(u,t)}i=ft.fromString(n,l||40)}else throw new Error("Invalid data");const r=ot.getBestVersionForData(i,t);if(!r)throw new Error("The amount of data is too big to be stored in a QR Code");if(!o)o=r;else if(o<r)throw new Error(`
The chosen QR Code version cannot contain this amount of data.
Minimum version required to store current data is: `+r+`.
`);const s=Ie(o,t,i),c=nt.getSymbolSize(o),a=new ue(c);return Ce(a,o),we(a),ye(a,o),dt(a,t,0),o>=7&&be(a,o),Fe(a,s),isNaN(e)&&(e=ht.getBestMask(a,dt.bind(null,a,t))),ht.applyMask(e,a),dt(a,t,e),{modules:a,version:o,errorCorrectionLevel:t,maskPattern:e,segments:i}}B.create=function(o,t){if(typeof o=="undefined"||o==="")throw new Error("No input text");let e=lt.M,i,r;return typeof t!="undefined"&&(e=lt.from(t.errorCorrectionLevel,lt.M),i=ot.from(t.version),r=ht.from(t.maskPattern),t.toSJISFunc&&nt.setToSJISFunction(t.toSJISFunc)),Ee(o,i,e,r)};var Dt={},gt={};(function(n){function o(t){if(typeof t=="number"&&(t=t.toString()),typeof t!="string")throw new Error("Color should be defined as hex string");let e=t.slice().replace("#","").split("");if(e.length<3||e.length===5||e.length>8)throw new Error("Invalid hex color: "+t);(e.length===3||e.length===4)&&(e=Array.prototype.concat.apply([],e.map(function(r){return[r,r]}))),e.length===6&&e.push("F","F");const i=parseInt(e.join(""),16);return{r:i>>24&255,g:i>>16&255,b:i>>8&255,a:i&255,hex:"#"+e.slice(0,6).join("")}}n.getOptions=function(e){e||(e={}),e.color||(e.color={});const i=typeof e.margin=="undefined"||e.margin===null||e.margin<0?4:e.margin,r=e.width&&e.width>=21?e.width:void 0,s=e.scale||4;return{width:r,scale:r?4:s,margin:i,color:{dark:o(e.color.dark||"#000000ff"),light:o(e.color.light||"#ffffffff")},type:e.type,rendererOpts:e.rendererOpts||{}}},n.getScale=function(e,i){return i.width&&i.width>=e+i.margin*2?i.width/(e+i.margin*2):i.scale},n.getImageWidth=function(e,i){const r=n.getScale(e,i);return Math.floor((e+i.margin*2)*r)},n.qrToImageData=function(e,i,r){const s=i.modules.size,c=i.modules.data,a=n.getScale(s,r),l=Math.floor((s+r.margin*2)*a),u=r.margin*a,m=[r.color.light,r.color.dark];for(let f=0;f<l;f++)for(let d=0;d<l;d++){let y=(f*l+d)*4,w=r.color.light;if(f>=u&&d>=u&&f<l-u&&d<l-u){const E=Math.floor((f-u)/a),C=Math.floor((d-u)/a);w=m[c[E*s+C]?1:0]}e[y++]=w.r,e[y++]=w.g,e[y++]=w.b,e[y]=w.a}}})(gt),function(n){const o=gt;function t(i,r,s){i.clearRect(0,0,r.width,r.height),r.style||(r.style={}),r.height=s,r.width=s,r.style.height=s+"px",r.style.width=s+"px"}function e(){try{return document.createElement("canvas")}catch(i){throw new Error("You need to specify a canvas element")}}n.render=function(r,s,c){let a=c,l=s;typeof a=="undefined"&&(!s||!s.getContext)&&(a=s,s=void 0),s||(l=e()),a=o.getOptions(a);const u=o.getImageWidth(r.modules.size,a),m=l.getContext("2d"),f=m.createImageData(u,u);return o.qrToImageData(f.data,r,a),t(m,l,u),m.putImageData(f,0,0),l},n.renderToDataURL=function(r,s,c){let a=c;typeof a=="undefined"&&(!s||!s.getContext)&&(a=s,s=void 0),a||(a={});const l=n.render(r,s,a),u=a.type||"image/png",m=a.rendererOpts||{};return l.toDataURL(u,m.quality)}}(Dt);var kt={};const Te=gt;function Rt(n,o){const t=n.a/255,e=o+'="'+n.hex+'"';return t<1?e+" "+o+'-opacity="'+t.toFixed(2).slice(1)+'"':e}function pt(n,o,t){let e=n+o;return typeof t!="undefined"&&(e+=" "+t),e}function Ae(n,o,t){let e="",i=0,r=!1,s=0;for(let c=0;c<n.length;c++){const a=Math.floor(c%o),l=Math.floor(c/o);!a&&!r&&(r=!0),n[c]?(s++,c>0&&a>0&&n[c-1]||(e+=r?pt("M",a+t,.5+l+t):pt("m",i,0),i=0,r=!1),a+1<o&&n[c+1]||(e+=pt("h",s),s=0)):i++}return e}kt.render=function(o,t,e){const i=Te.getOptions(t),r=o.modules.size,s=o.modules.data,c=r+i.margin*2,a=i.color.light.a?"<path "+Rt(i.color.light,"fill")+' d="M0 0h'+c+"v"+c+'H0z"/>':"",l="<path "+Rt(i.color.dark,"stroke")+' d="'+Ae(s,r,i.margin)+'"/>',u='viewBox="0 0 '+c+" "+c+'"',f='<svg xmlns="http://www.w3.org/2000/svg" '+(i.width?'width="'+i.width+'" height="'+i.width+'" ':"")+u+' shape-rendering="crispEdges">'+a+l+`</svg>
`;return typeof e=="function"&&e(null,f),f};const Pe=L,mt=B,Ut=Dt,Be=kt;function Ct(n,o,t,e,i){const r=[].slice.call(arguments,1),s=r.length,c=typeof r[s-1]=="function";if(!c&&!Pe())throw new Error("Callback required as last argument");if(c){if(s<2)throw new Error("Too few arguments provided");s===2?(i=t,t=o,o=e=void 0):s===3&&(o.getContext&&typeof i=="undefined"?(i=e,e=void 0):(i=e,e=t,t=o,o=void 0))}else{if(s<1)throw new Error("Too few arguments provided");return s===1?(t=o,o=e=void 0):s===2&&!o.getContext&&(e=t,t=o,o=void 0),new Promise(function(a,l){try{const u=mt.create(t,e);a(n(u,o,e))}catch(u){l(u)}})}try{const a=mt.create(t,e);i(null,n(a,o,e))}catch(a){i(a)}}mt.create,Ct.bind(null,Ut.render);var Le=Ct.bind(null,Ut.renderToDataURL);Ct.bind(null,function(n,o,t){return Be.render(n,t)});const j=1e3,$t={iceServers:[{urls:["stun:stun1.l.google.com:19302"]}]};function Me(){return crypto.randomUUID()}function wt(n){return S(this,null,function*(){return yield(yield fetch(n)).json()})}function _t(n,o){for(const t of n)if(JSON.stringify(t)===JSON.stringify(o))return!0;return!1}class Y{constructor(){h(this,"eventListeners",{})}on(o,t){var i;const e=(i=this.eventListeners[o])!=null?i:new Set;e.add(t),this.eventListeners[o]=e}off(o,t){const e=this.eventListeners[o];e&&(e.delete(t),e.size===0&&delete this.eventListeners[o])}emit(o,...t){var i;const e=(i=this.eventListeners[o])!=null?i:new Set;for(const r of e)r(...t)}}class zt extends Y{}class Ht extends Y{constructor({flottformApi:t,createClientUrl:e,pollTimeForIceInMs:i,logger:r}){super();h(this,"flottformApi");h(this,"createClientUrl");h(this,"rtcConfiguration");h(this,"pollTimeForIceInMs");h(this,"logger");h(this,"state","new");h(this,"channelNumber",0);h(this,"openPeerConnection",null);h(this,"dataChannel",null);h(this,"pollForIceTimer",null);h(this,"changeState",(t,e)=>{this.state=t,this.emit(t,e),this.logger.info(`State changed to: ${t}`,e==null?"":e)});h(this,"start",()=>S(this,null,function*(){this.openPeerConnection&&this.close();const t=(this.flottformApi instanceof URL?this.flottformApi:new URL(this.flottformApi)).toString().replace(/\/$/,"");try{this.rtcConfiguration.iceServers=yield this.fetchIceServers(t)}catch(u){this.logger.error(u)}this.openPeerConnection=new RTCPeerConnection(this.rtcConfiguration),this.dataChannel=this.createDataChannel();const e=yield this.openPeerConnection.createOffer();yield this.openPeerConnection.setLocalDescription(e);const{endpointId:i,hostKey:r}=yield this.createEndpoint(t,e);this.logger.log("Created endpoint",{endpointId:i,hostKey:r});const s=`${t}/${i}`,c=`${t}/${i}/host`,a=new Set;yield this.putHostInfo(c,r,a,e),this.setUpConnectionStateGathering(s),this.setupHostIceGathering(c,r,a,e),this.setupDataChannelForTransfer();const l=yield this.createClientUrl({endpointId:i});this.changeState("waiting-for-client",{qrCode:yield Le(l),link:l,channel:this}),this.setupDataChannelListener()}));h(this,"close",()=>{this.openPeerConnection&&(this.openPeerConnection.close(),this.openPeerConnection=null),this.changeState("disconnected")});h(this,"setupDataChannelListener",()=>{if(this.dataChannel==null){this.changeState("error","dataChannel is null. Unable to setup the listeners for the data channel");return}this.dataChannel.onmessage=t=>{this.emit("receiving-data",t)}});h(this,"setupHostIceGathering",(t,e,i,r)=>{if(this.openPeerConnection===null){this.changeState("error","openPeerConnection is null. Unable to gather Host ICE candidates");return}this.openPeerConnection.onicecandidate=s=>S(this,null,function*(){this.logger.info(`onicecandidate - ${this.openPeerConnection.connectionState} - ${s.candidate}`),s.candidate&&(_t(i,s.candidate)||(this.logger.log("host found new ice candidate! Adding it to our list"),i.add(s.candidate),yield this.putHostInfo(t,e,i,r)))}),this.openPeerConnection.onicegatheringstatechange=s=>S(this,null,function*(){this.logger.info(`onicegatheringstatechange - ${this.openPeerConnection.iceGatheringState} - ${s}`)}),this.openPeerConnection.onicecandidateerror=s=>S(this,null,function*(){this.logger.error("peerConnection.onicecandidateerror",s)})});h(this,"setUpConnectionStateGathering",t=>{if(this.openPeerConnection===null){this.changeState("error","openPeerConnection is null. Unable to poll for the client's details");return}this.startPollingForConnection(t),this.openPeerConnection.onconnectionstatechange=()=>{this.logger.info(`onconnectionstatechange - ${this.openPeerConnection.connectionState}`),this.openPeerConnection.connectionState==="connected"&&this.stopPollingForConnection(),this.openPeerConnection.connectionState==="disconnected"&&this.startPollingForConnection(t),this.openPeerConnection.connectionState==="failed"&&(this.stopPollingForConnection(),this.changeState("error",{message:"connection-failed"}))},this.openPeerConnection.oniceconnectionstatechange=e=>S(this,null,function*(){this.logger.info(`oniceconnectionstatechange - ${this.openPeerConnection.iceConnectionState} - ${e}`),this.openPeerConnection.iceConnectionState==="failed"&&(this.logger.log("Failed to find a possible connection path"),this.changeState("error",{message:"connection-impossible"}))})});h(this,"stopPollingForConnection",()=>S(this,null,function*(){this.pollForIceTimer&&clearTimeout(this.pollForIceTimer),this.pollForIceTimer=null}));h(this,"startPollingForConnection",t=>S(this,null,function*(){this.pollForIceTimer&&clearTimeout(this.pollForIceTimer),yield this.pollForConnection(t),this.pollForIceTimer=setTimeout(()=>{this.startPollingForConnection(t)},this.pollTimeForIceInMs)}));h(this,"createEndpoint",(t,e)=>S(this,null,function*(){return(yield fetch(`${t}/create`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({session:e})})).json()}));h(this,"fetchIceServers",t=>S(this,null,function*(){const e=yield fetch(`${t}/ice-server-credentials`,{method:"GET",headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Fetching Error!");const i=yield e.json();if(i.success===!1)throw new Error(i.message||"Unknown error occurred");return i.iceServers}));h(this,"pollForConnection",t=>S(this,null,function*(){var i;if(this.openPeerConnection===null){this.changeState("error","openPeerConnection is null. Unable to retrieve Client's details");return}this.logger.log("polling for client ice candidates",this.openPeerConnection.iceGatheringState);const{clientInfo:e}=yield wt(t);e&&this.state==="waiting-for-client"&&(this.logger.log("Found a client that wants to connect!"),this.changeState("waiting-for-ice"),yield this.openPeerConnection.setRemoteDescription(e.session));for(const r of(i=e==null?void 0:e.iceCandidates)!=null?i:[])yield this.openPeerConnection.addIceCandidate(r)}));h(this,"setupDataChannelForTransfer",()=>{if(this.dataChannel===null){this.changeState("error","dataChannel is null. Unable to setup a Data Channel");return}this.dataChannel.onopen=()=>{this.logger.log("data channel opened"),this.changeState("waiting-for-data")},this.dataChannel.onclose=()=>{this.logger.log("data channel closed")},this.dataChannel.onerror=t=>{this.logger.log("channel.onerror",t),this.changeState("error",{message:"file-transfer"})}});h(this,"createDataChannel",()=>{if(this.openPeerConnection===null)return this.changeState("error","openPeerConnection is null. Unable to create a new Data Channel"),null;this.channelNumber++;const t=`data-channel-${this.channelNumber}`;return this.openPeerConnection.createDataChannel(t)});h(this,"putHostInfo",(t,e,i,r)=>S(this,null,function*(){try{if(this.logger.log("Updating host info with new list of ice candidates"),!(yield fetch(t,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({hostKey:e,iceCandidates:[...i],session:r})})).ok)throw Error("Could not update host info")}catch(s){this.changeState("error",s)}}));this.flottformApi=t,this.createClientUrl=e,this.rtcConfiguration=$t,this.pollTimeForIceInMs=i,this.logger=r,Promise.resolve().then(()=>{this.changeState("new",{channel:this})})}}class Ot extends zt{constructor({flottformApi:t,createClientUrl:e,inputField:i,pollTimeForIceInMs:r=j,logger:s=console}){super();h(this,"channel",null);h(this,"inputField");h(this,"logger");h(this,"filesMetaData",[]);h(this,"filesTotalSize",0);h(this,"receivedDataSize",0);h(this,"currentFile",null);h(this,"link","");h(this,"qrCode","");h(this,"start",()=>{var t;(t=this.channel)==null||t.start()});h(this,"close",()=>{var t;(t=this.channel)==null||t.close()});h(this,"getLink",()=>(this.link===""&&this.logger.error("Flottform is currently establishing the connection. Link is unavailable for now!"),this.link));h(this,"getQrCode",()=>(this.qrCode===""&&this.logger.error("Flottform is currently establishing the connection. qrCode is unavailable for now!"),this.qrCode));h(this,"handleIncomingData",t=>{var e,i,r;if(typeof t.data=="string"){const s=JSON.parse(t.data);s.type==="file-transfer-meta"?(this.filesMetaData=s.filesQueue,this.currentFile={index:0,receivedSize:0,arrayBuffer:[]},this.filesTotalSize=s.totalSize,this.emit("receive")):s.type==="transfer-complete"&&(this.emit("done"),(e=this.channel)==null||e.close())}else if(t.data instanceof ArrayBuffer&&this.currentFile){this.currentFile.arrayBuffer.push(t.data),this.currentFile.receivedSize+=t.data.byteLength,this.receivedDataSize+=t.data.byteLength;const s=(i=this.filesMetaData[this.currentFile.index])==null?void 0:i.name,c=(r=this.filesMetaData[this.currentFile.index])==null?void 0:r.size,a=(this.currentFile.receivedSize/c).toFixed(2),l=(this.receivedDataSize/this.filesTotalSize).toFixed(2);this.emit("progress",{fileIndex:this.currentFile.index,totalFileCount:this.filesMetaData.length,fileName:s,currentFileProgress:parseFloat(a),overallProgress:parseFloat(l)}),this.currentFile.receivedSize===c&&(this.appendFileToInputField(this.currentFile.index),this.currentFile={index:this.currentFile.index+1,receivedSize:0,arrayBuffer:[]})}});h(this,"appendFileToInputField",t=>{var c,a,l,u,m;if(!this.inputField){this.logger.warn("No input field provided!!");return}this.inputField.multiple||(this.logger.warn("Input field does not accept multiple files. Setting multiple to true."),this.inputField.multiple=!0);const e=new DataTransfer;if(this.inputField.files)for(const f of Array.from(this.inputField.files))e.items.add(f);const i=(a=(c=this.filesMetaData[t])==null?void 0:c.name)!=null?a:"no-name",r=(u=(l=this.filesMetaData[t])==null?void 0:l.type)!=null?u:"application/octet-stream",s=new File((m=this.currentFile)==null?void 0:m.arrayBuffer,i,{type:r});e.items.add(s),this.inputField.files=e.files});h(this,"registerListeners",()=>{var t,e,i,r,s,c,a;(t=this.channel)==null||t.on("new",()=>{this.emit("new")}),(e=this.channel)==null||e.on("waiting-for-client",l=>{this.emit("webrtc:waiting-for-client",l);const{qrCode:u,link:m}=l;this.emit("endpoint-created",{link:m,qrCode:u}),this.link=m,this.qrCode=u}),(i=this.channel)==null||i.on("waiting-for-ice",()=>{this.emit("webrtc:waiting-for-ice")}),(r=this.channel)==null||r.on("waiting-for-data",()=>{this.emit("webrtc:waiting-for-file"),this.emit("connected")}),(s=this.channel)==null||s.on("receiving-data",l=>{this.handleIncomingData(l)}),(c=this.channel)==null||c.on("disconnected",()=>{this.emit("disconnected")}),(a=this.channel)==null||a.on("error",l=>{this.emit("error",l)})});this.channel=new Ht({flottformApi:t,createClientUrl:e,pollTimeForIceInMs:r,logger:s}),this.inputField=i,this.logger=s,this.registerListeners()}}class qt extends Y{constructor({endpointId:t,flottformApi:e,pollTimeForIceInMs:i=j,logger:r=console}){super();h(this,"flottformApi");h(this,"endpointId");h(this,"rtcConfiguration");h(this,"pollTimeForIceInMs");h(this,"logger");h(this,"state","init");h(this,"openPeerConnection",null);h(this,"dataChannel",null);h(this,"pollForIceTimer",null);h(this,"BUFFER_THRESHOLD",131072);h(this,"changeState",(t,e)=>{this.state=t,this.emit(t,e),this.logger.info(`**Client State changed to: ${t}`,e==null?"":e)});h(this,"start",()=>S(this,null,function*(){this.openPeerConnection&&this.close();const t=(this.flottformApi instanceof URL?this.flottformApi:new URL(this.flottformApi)).toString().replace(/\/$/,"");try{this.rtcConfiguration.iceServers=yield this.fetchIceServers(t)}catch(l){this.logger.error(l)}this.openPeerConnection=new RTCPeerConnection(this.rtcConfiguration);const e=Me(),i=new Set,r=`${this.flottformApi}/${this.endpointId}`,s=`${this.flottformApi}/${this.endpointId}/client`;this.changeState("retrieving-info-from-endpoint");const{hostInfo:c}=yield wt(r);yield this.openPeerConnection.setRemoteDescription(c.session);const a=yield this.openPeerConnection.createAnswer();yield this.openPeerConnection.setLocalDescription(a),this.setUpConnectionStateGathering(r),this.setUpClientIceGathering(s,e,i,a),this.openPeerConnection.ondatachannel=l=>{this.logger.info(`ondatachannel: ${l.channel}`),this.changeState("connected"),this.dataChannel=l.channel,this.dataChannel.bufferedAmountLowThreshold=this.BUFFER_THRESHOLD,this.dataChannel.onbufferedamountlow=()=>{this.emit("bufferedamountlow")},this.dataChannel.onopen=u=>{this.logger.info(`ondatachannel - onopen: ${u.type}`)}},this.changeState("sending-client-info"),yield this.putClientInfo(s,e,i,a),this.changeState("connecting-to-host"),this.startPollingForIceCandidates(r)}));h(this,"close",()=>{this.openPeerConnection&&(this.openPeerConnection.close(),this.openPeerConnection=null),this.changeState("disconnected")});h(this,"sendData",t=>{if(this.dataChannel==null){this.changeState("error","dataChannel is null. Unable to send the file to the Host!");return}else if(!this.canSendMoreData()){this.logger.warn("Data channel is full! Cannot send data at the moment");return}this.dataChannel.send(t)});h(this,"canSendMoreData",()=>this.dataChannel&&this.dataChannel.bufferedAmount<this.dataChannel.bufferedAmountLowThreshold);h(this,"setUpClientIceGathering",(t,e,i,r)=>{if(this.openPeerConnection===null){this.changeState("error","openPeerConnection is null. Unable to gather Client ICE candidates");return}this.openPeerConnection.onicecandidate=s=>S(this,null,function*(){this.logger.info(`onicecandidate - ${this.openPeerConnection.connectionState} - ${s.candidate}`),s.candidate&&(_t(i,s.candidate)||(this.logger.log("client found new ice candidate! Adding it to our list"),i.add(s.candidate),yield this.putClientInfo(t,e,i,r)))}),this.openPeerConnection.onicegatheringstatechange=()=>S(this,null,function*(){this.logger.info(`onicegatheringstatechange - ${this.openPeerConnection.iceGatheringState}`)}),this.openPeerConnection.onicecandidateerror=s=>{this.logger.error(`onicecandidateerror - ${this.openPeerConnection.connectionState}`,s)}});h(this,"setUpConnectionStateGathering",t=>{if(this.openPeerConnection===null){this.changeState("error","openPeerConnection is null. Unable to gather Client ICE candidates");return}this.openPeerConnection.onconnectionstatechange=()=>{this.logger.info(`onconnectionstatechange - ${this.openPeerConnection.connectionState}`),this.openPeerConnection.connectionState==="connected"&&(this.stopPollingForIceCandidates(),this.state==="connecting-to-host"&&this.changeState("connected")),this.openPeerConnection.connectionState==="disconnected"&&this.startPollingForIceCandidates(t),this.openPeerConnection.connectionState==="failed"&&(this.stopPollingForIceCandidates(),this.state!=="done"&&this.changeState("disconnected"))},this.openPeerConnection.oniceconnectionstatechange=()=>{this.logger.info(`oniceconnectionstatechange - ${this.openPeerConnection.iceConnectionState}`),this.openPeerConnection.iceConnectionState==="failed"&&(this.logger.log("Failed to find a possible connection path"),this.changeState("connection-impossible"))}});h(this,"stopPollingForIceCandidates",()=>S(this,null,function*(){this.pollForIceTimer&&clearTimeout(this.pollForIceTimer),this.pollForIceTimer=null}));h(this,"startPollingForIceCandidates",t=>S(this,null,function*(){this.pollForIceTimer&&clearTimeout(this.pollForIceTimer),yield this.pollForConnection(t),this.pollForIceTimer=setTimeout(this.startPollingForIceCandidates,this.pollTimeForIceInMs)}));h(this,"pollForConnection",t=>S(this,null,function*(){if(this.openPeerConnection===null){this.changeState("error","openPeerConnection is null. Unable to retrieve Host's details");return}this.logger.log("polling for host ice candidates",this.openPeerConnection.iceGatheringState);const{hostInfo:e}=yield wt(t);for(const i of e.iceCandidates)yield this.openPeerConnection.addIceCandidate(i)}));h(this,"putClientInfo",(t,e,i,r)=>S(this,null,function*(){if(this.logger.log("Updating client info with new list of ice candidates"),!(yield fetch(t,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({clientKey:e,iceCandidates:[...i],session:r})})).ok)throw Error("Could not update client info. Did another peer already connect?")}));h(this,"fetchIceServers",t=>S(this,null,function*(){const e=yield fetch(`${t}/ice-server-credentials`,{method:"GET",headers:{Accept:"application/json"}});if(!e.ok)throw new Error("Fetching Error!");const i=yield e.json();if(i.success===!1)throw new Error(i.message||"Unknown error occurred");return i.iceServers}));this.endpointId=t,this.flottformApi=e,this.rtcConfiguration=$t,this.pollTimeForIceInMs=i,this.logger=r}}class ve extends Y{constructor({endpointId:t,fileInput:e,flottformApi:i,pollTimeForIceInMs:r=j,logger:s=console}){super();h(this,"channel",null);h(this,"inputField");h(this,"chunkSize",16384);h(this,"filesMetaData",[]);h(this,"filesArrayBuffer",[]);h(this,"currentFileIndex",0);h(this,"currentChunkIndex",0);h(this,"allFilesSent",!1);h(this,"logger");h(this,"start",()=>{var t;(t=this.channel)==null||t.start()});h(this,"close",()=>{var t;(t=this.channel)==null||t.close()});h(this,"createMetaData",t=>{if(!t.files)return null;const i=Array.from(t.files).map(r=>({name:r.name,type:r.type,size:r.size}));return{type:"file-transfer-meta",filesQueue:i,totalSize:i.reduce((r,s)=>r+s.size,0)}});h(this,"createArrayBuffers",t=>S(this,null,function*(){if(!t.files)return null;const e=Array.from(t.files);return yield Promise.all(e.map(i=>S(this,null,function*(){return yield i.arrayBuffer()})))}));h(this,"sendFiles",()=>S(this,null,function*(){var i;const t=this.createMetaData(this.inputField),e=yield this.createArrayBuffers(this.inputField);if(!t||!e)throw new Error("Can't find the files that you want to send!");this.filesMetaData=t.filesQueue,this.filesArrayBuffer=e,(i=this.channel)==null||i.sendData(JSON.stringify(t)),this.emit("sending"),this.startSendingFiles()}));h(this,"startSendingFiles",()=>{this.sendNextChunk()});h(this,"sendNextChunk",()=>S(this,null,function*(){var s,c,a,l;const t=this.filesMetaData.length;if(this.allFilesSent||this.currentFileIndex>=t){this.logger.log("All files are sent"),(s=this.channel)==null||s.sendData(JSON.stringify({type:"transfer-complete"})),this.allFilesSent=!0,(c=this.channel)==null||c.off("bufferedamountlow",this.startSendingFiles),this.emit("done");return}const e=this.filesArrayBuffer[this.currentFileIndex];if(!e)throw new Error(`Can't find the ArrayBuffer for the file number ${this.currentFileIndex}`);const i=e.byteLength,r=this.filesMetaData[this.currentFileIndex].name;for(;this.currentChunkIndex*this.chunkSize<i;){if(!((a=this.channel)!=null&&a.canSendMoreData())){this.logger.log("Buffer is full. Pausing sending chunks!");break}const u=(this.currentChunkIndex*this.chunkSize/i).toFixed(2);this.emit("progress",{fileIndex:this.currentFileIndex,fileName:r,progress:parseFloat(u)});const m=this.currentChunkIndex*this.chunkSize,f=Math.min((this.currentChunkIndex+1)*this.chunkSize,i);(l=this.channel)==null||l.sendData(e.slice(m,f)),this.currentChunkIndex++}this.currentChunkIndex*this.chunkSize>=i?(this.logger.log(`File ${r} fully sent. Moving to next file.`),this.currentFileIndex++,this.currentChunkIndex=0,this.sendNextChunk()):setTimeout(this.sendNextChunk,100)}));h(this,"registerListeners",()=>{var t,e,i,r,s,c,a,l,u,m;(t=this.channel)==null||t.on("init",()=>{}),(e=this.channel)==null||e.on("retrieving-info-from-endpoint",()=>{}),(i=this.channel)==null||i.on("sending-client-info",()=>{}),(r=this.channel)==null||r.on("connecting-to-host",()=>{}),(s=this.channel)==null||s.on("connected",()=>{this.emit("connected")}),(c=this.channel)==null||c.on("connection-impossible",()=>{this.emit("webrtc:connection-impossible")}),(a=this.channel)==null||a.on("done",()=>{this.emit("done")}),(l=this.channel)==null||l.on("disconnected",()=>{this.emit("disconnected")}),(u=this.channel)==null||u.on("error",f=>{this.emit("error",f)}),(m=this.channel)==null||m.on("bufferedamountlow",this.startSendingFiles)});this.channel=new qt({endpointId:t,flottformApi:i,pollTimeForIceInMs:r,logger:s}),this.inputField=e,this.logger=s,this.registerListeners()}}class Ne extends Y{constructor({endpointId:t,flottformApi:e,pollTimeForIceInMs:i=j,logger:r=console}){super();h(this,"channel",null);h(this,"logger");h(this,"start",()=>{var t;(t=this.channel)==null||t.start()});h(this,"close",()=>{var t;(t=this.channel)==null||t.close()});h(this,"sendText",t=>{var e;this.emit("sending"),(e=this.channel)==null||e.sendData(t),this.emit("done")});h(this,"registerListeners",()=>{var t,e,i,r,s,c,a,l,u;(t=this.channel)==null||t.on("init",()=>{}),(e=this.channel)==null||e.on("retrieving-info-from-endpoint",()=>{}),(i=this.channel)==null||i.on("sending-client-info",()=>{}),(r=this.channel)==null||r.on("connecting-to-host",()=>{}),(s=this.channel)==null||s.on("connected",()=>{this.emit("connected")}),(c=this.channel)==null||c.on("connection-impossible",()=>{this.emit("webrtc:connection-impossible")}),(a=this.channel)==null||a.on("done",()=>{this.emit("done")}),(l=this.channel)==null||l.on("disconnected",()=>{this.emit("disconnected")}),(u=this.channel)==null||u.on("error",m=>{this.emit("error",m)})});this.channel=new qt({endpointId:t,flottformApi:e,pollTimeForIceInMs:i,logger:r}),this.logger=r,this.registerListeners()}}class Jt extends zt{constructor({flottformApi:t,createClientUrl:e,pollTimeForIceInMs:i=j,logger:r=console}){super();h(this,"channel",null);h(this,"logger");h(this,"link","");h(this,"qrCode","");h(this,"start",()=>{var t;(t=this.channel)==null||t.start(),console.log("FlottformTextInputHost is working")});h(this,"close",()=>{var t;(t=this.channel)==null||t.close()});h(this,"getLink",()=>(this.link===""&&this.logger.error("Flottform is currently establishing the connection. Link is unavailable for now!"),this.link));h(this,"getQrCode",()=>(this.qrCode===""&&this.logger.error("Flottform is currently establishing the connection. qrCode is unavailable for now!"),this.qrCode));h(this,"handleIncomingData",t=>{this.emit("receive"),this.emit("done",t.data)});h(this,"registerListeners",()=>{var t,e,i,r,s,c,a;(t=this.channel)==null||t.on("new",()=>{this.emit("new"),console.log('[FlottformTextInputHost]- "new" event is FIRED')}),(e=this.channel)==null||e.on("waiting-for-client",l=>{this.emit("webrtc:waiting-for-client",l);const{qrCode:u,link:m}=l;this.emit("endpoint-created",{link:m,qrCode:u}),console.log('[FlottformTextInputHost]- "endpoint-created" event is FIRED'),this.link=m,this.qrCode=u}),(i=this.channel)==null||i.on("waiting-for-ice",()=>{this.emit("webrtc:waiting-for-ice")}),(r=this.channel)==null||r.on("waiting-for-data",()=>{this.emit("webrtc:waiting-for-data"),this.emit("connected"),console.log('[FlottformTextInputHost]- "connected" event is FIRED')}),(s=this.channel)==null||s.on("receiving-data",l=>{this.handleIncomingData(l)}),(c=this.channel)==null||c.on("disconnected",()=>{this.emit("disconnected"),console.log('[FlottformTextInputHost]- "disconnected" event is FIRED')}),(a=this.channel)==null||a.on("error",l=>{this.emit("error",l),console.log('[FlottformTextInputHost]- "error" event is FIRED')})});this.channel=new Ht({flottformApi:t,createClientUrl:e,pollTimeForIceInMs:i,logger:r}),this.logger=r,this.registerListeners()}}const De=()=>{const n=document.querySelector(".flottform-elements-container-wrapper"),o=document.querySelector(".flottform-opener-triangle");n.classList.toggle("flottform-open"),o.classList.toggle("flottform-button-svg-open")},ke=(n,o,t)=>{const e=document.createElement("div");e.setAttribute("class",`flottform-root${t!=null?t:""}`);const i=ze(n);e.appendChild(i);const r=He(o);return e.appendChild(r),e},Re=(n,o)=>{const t=document.createElement("img");t.setAttribute("class","flottform-qr-code"),t.setAttribute("src",n);const e=document.createElement("div");return e.setAttribute("class","flottform-link-offer"),e.innerText=o,{createChannelQrCode:t,createChannelLinkWithOffer:e}},Ue=({flottformAnchorElement:n,flottformRootElement:o,additionalComponentClass:t,flottformRootTitle:e,flottformRootDescription:i})=>{var a;const r=(a=o!=null?o:document.querySelector(".flottform-root"))!=null?a:ke(e,i,t),s=r.querySelector(".flottform-elements-container"),c=r.querySelector(".flottform-elements-container-wrapper");return c.appendChild(s),r.appendChild(c),n.appendChild(r),{flottformRoot:r,getAllFlottformItems:()=>{const l=r.querySelector(".flottform-inputs-list");return l?l.childNodes:(console.error("No element with class .flottform-inputs-list found"),null)},createFileItem:({flottformApi:l,createClientUrl:u,inputField:m,id:f,additionalItemClasses:d,label:y,buttonLabel:w,onErrorText:E,onSuccessText:C})=>{const b=new Ot({flottformApi:l,createClientUrl:u,inputField:m}),{flottformItem:g,statusInformation:p,refreshChannelButton:F,flottformStateItemsContainer:I}=xt({flottformBaseInputHost:b,additionalItemClasses:d,label:y,buttonLabel:w,onErrorText:E}),T=r.querySelector(".flottform-inputs-list");T.appendChild(g),s.appendChild(T),$e({flottformItem:g,statusInformation:p,refreshChannelButton:F,flottformStateItemsContainer:I,flottformFileInputHost:b,id:f,onSuccessText:C})},createTextItem:({flottformApi:l,createClientUrl:u,inputField:m,id:f,additionalItemClasses:d,label:y,buttonLabel:w,onErrorText:E,onSuccessText:C})=>{const b=new Jt({flottformApi:l,createClientUrl:u}),{flottformItem:g,statusInformation:p,refreshChannelButton:F}=xt({flottformBaseInputHost:b,additionalItemClasses:d,label:y,buttonLabel:w,onErrorText:E}),I=r.querySelector(".flottform-inputs-list");I.appendChild(g),s.appendChild(I),_e({flottformItem:g,statusInformation:p,refreshChannelButton:F,flottformTextInputHost:b,id:f,onSuccessText:C,inputField:m})}}},xt=({flottformBaseInputHost:n,additionalItemClasses:o,label:t,buttonLabel:e,onErrorText:i})=>{const r=Oe(o);Ve({label:t,flottformItem:r});const s=qe(),c=xe(e);c.addEventListener("click",()=>n.start());const a=Je(c);r.appendChild(a);const l=Ke();return l.addEventListener("click",()=>n.start()),n.on("endpoint-created",({link:u,qrCode:m})=>{const{createChannelQrCode:f,createChannelLinkWithOffer:d}=Re(m,u),y=je();a.replaceChildren(f);const w=document.createElement("div");w.setAttribute("class","flottform-copy-button-link-wrapper"),w.appendChild(y),w.appendChild(d),a.appendChild(w)}),n.on("connected",()=>{s.innerHTML="Connected",s.appendChild(l),a.replaceChildren(s)}),n.on("error",u=>{s.innerHTML=typeof i=="function"?i(u):i!=null?i:` An error occured (${u.message}). Please try again`,c.innerText="Retry",a.replaceChildren(s),a.appendChild(c)}),{flottformItem:r,statusInformation:s,refreshChannelButton:l,flottformStateItemsContainer:a}},$e=({flottformItem:n,statusInformation:o,refreshChannelButton:t,flottformStateItemsContainer:e,flottformFileInputHost:i,id:r,onSuccessText:s})=>{r&&n.setAttribute("id",r),i.on("progress",({currentFileProgress:c,overallProgress:a,fileIndex:l,totalFileCount:u,fileName:m})=>{Ye(e),tn(e,a,l,u);const f=Qe(e);Ze(l,m,c,f,e)}),i.on("done",()=>{o.innerHTML=s!=null?s:" You have succesfully downloaded all your files.",o.appendChild(t),e.replaceChildren(o)})},_e=({flottformItem:n,statusInformation:o,refreshChannelButton:t,flottformTextInputHost:e,id:i,onSuccessText:r,inputField:s})=>{i&&n.setAttribute("id",i),e.on("done",c=>{if(o.innerHTML=r!=null?r:" You have succesfully submitted your message",o.appendChild(t),n.replaceChildren(o),s){s.setAttribute("value",c);const a=new Event("change");s.dispatchEvent(a)}})},ze=n=>{const o=document.createElement("button");return o.setAttribute("type","button"),o.setAttribute("class","flottform-root-opener-button"),o.innerHTML=`<span>${n!=null?n:"Fill from Another Device"}</span><svg class="flottform-opener-triangle" width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M6.5,8.5l6,7l6-7H6.5z"/></svg>`,o.addEventListener("click",()=>De()),o},He=n=>{const o=document.createElement("div");o.setAttribute("class","flottform-elements-container");const t=document.createElement("div");if(t.setAttribute("class","flottform-elements-container-wrapper"),n!==""){const i=document.createElement("div");i.setAttribute("class","flottform-root-description"),i.innerText=n!=null?n:"This form is powered by Flottform. Need to add details from another device? Simply click a button below to generate a QR code or link, and easily upload information from your other device.",o.appendChild(i)}const e=document.createElement("ul");return e.setAttribute("class","flottform-inputs-list"),o.appendChild(e),t.appendChild(o),t},Oe=n=>{const o=document.createElement("li");return o.setAttribute("class",`flottform-item${n!=null?n:""}`),o},qe=()=>{const n=document.createElement("div");return n.setAttribute("class","flottform-status-information"),n},Je=n=>{const o=document.createElement("div");return o.setAttribute("class","flottform-state-items-container"),o.appendChild(n),o},xe=n=>{const o=document.createElement("button");return o.setAttribute("type","button"),o.setAttribute("class","flottform-button"),o.innerText=n!=null?n:"Get a link",o},Ke=()=>{const n=document.createElement("button");return n.setAttribute("type","button"),n.setAttribute("class","flottform-refresh-connection-button"),n.setAttribute("title","Click this button to refresh Flottform connection for the input field. Previous connection will be closed"),n.setAttribute("aria-label","Click this button to refresh Flottform connection for the input field. Previous connection will be closed"),n.innerHTML='<svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M13.5 2c-5.288 0-9.649 3.914-10.377 9h-3.123l4 5.917 4-5.917h-2.847c.711-3.972 4.174-7 8.347-7 4.687 0 8.5 3.813 8.5 8.5s-3.813 8.5-8.5 8.5c-3.015 0-5.662-1.583-7.171-3.957l-1.2 1.775c1.916 2.536 4.948 4.182 8.371 4.182 5.797 0 10.5-4.702 10.5-10.5s-4.703-10.5-10.5-10.5z"/></svg>',n};let Ge=1;const Ve=({label:n,flottformItem:o})=>{const t=document.createElement("p"),e=n!=null?n:`File input ${Ge++}`;e&&(t.innerHTML=e,o.appendChild(t))},je=()=>{const n=document.createElement("button");return n.setAttribute("class","flottform-copy-to-clipboard"),n.setAttribute("type","button"),n.setAttribute("title","Copy Flottform link to clipboard"),n.setAttribute("aria-label","Copy Flottform link to clipboard"),n.innerText="",n.addEventListener("click",()=>S(this,null,function*(){const o=document.querySelector(".flottform-link-offer").innerText;navigator.clipboard.writeText(o).then(()=>{n.innerText="",setTimeout(()=>{n.innerText=""},1e3)}).catch(t=>{n.innerText=` Failed to copy: ${t}`,setTimeout(()=>{n.innerText=""},1e3)})})),n},Ye=n=>{n.querySelector(".flottform-status-information")&&(n.innerHTML="")},Qe=n=>{let o=n.querySelector("details");if(!o){o=document.createElement("details");const t=document.createElement("summary");t.innerText="Details",o.appendChild(t);const e=document.createElement("div");e.classList.add("details-container"),o.appendChild(e),n.appendChild(o)}return o},We=(n,o)=>{const t=document.createElement("label");t.setAttribute("id",`flottform-status-bar-${n}`),t.classList.add("flottform-progress-bar-label"),t.innerText=`File ${o} progress:`;const e=document.createElement("progress");return e.setAttribute("id",`flottform-status-bar-${n}`),e.classList.add("flottform-status-bar"),e.setAttribute("max","100"),e.setAttribute("value","0"),{currentFileLabel:t,progressBar:e}},Ze=(n,o,t,e,i)=>{let r=i.querySelector(`progress#flottform-status-bar-${n}`);if(!r){const{currentFileLabel:s,progressBar:c}=We(n,o);r=c;const a=e.querySelector(".details-container");a.appendChild(s),a.appendChild(r)}r.value=t*100,r.innerText=`${t*100}%`},Xe=()=>{const n=document.createElement("label");n.setAttribute("id","flottform-status-bar-overall-progress"),n.classList.add("flottform-progress-bar-label"),n.innerText="Receiving Files Progress";const o=document.createElement("progress");return o.setAttribute("id","flottform-status-bar-overall-progress"),o.classList.add("flottform-status-bar"),o.setAttribute("max","100"),o.setAttribute("value","0"),{overallFilesLabel:n,progressBar:o}},tn=(n,o,t,e)=>{let i=n.querySelector("progress#flottform-status-bar-overall-progress");if(!i){const{overallFilesLabel:s,progressBar:c}=Xe();i=c,n.appendChild(s),n.appendChild(i)}const r=n.querySelector("label#flottform-status-bar-overall-progress");i.value=o*100,i.innerText=`${o*100}%`,r.innerText=`Receiving file ${t+1} of ${e}`};return A.FlottformFileInputClient=ve,A.FlottformFileInputHost=Ot,A.FlottformTextInputClient=Ne,A.FlottformTextInputHost=Jt,A.createDefaultFlottformComponent=Ue,Object.defineProperty(A,Symbol.toStringTag,{value:"Module"}),A}({});
//# sourceMappingURL=content-script.js.map
